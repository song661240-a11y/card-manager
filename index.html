<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¿¡ç”¨å¡ç®¡å®¶</title>

    <!-- â–¼â–¼â–¼ App åœ–ç¤ºèˆ‡ PWA è¨­å®š â–¼â–¼â–¼ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22 rx=%2220%22></rect><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ğŸ’³</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22></rect><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ğŸ’³</text></svg>">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"ä¿¡ç”¨å¡ç®¡å®¶","short_name":"åˆ·å¡ç®¡å®¶","start_url":".","display":"standalone","background_color":"#f9fafb","theme_color":"#ffffff","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/633/633611.png","sizes":"192x192","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-item-active { color: #2563eb; transform: scale(1.1); }
        .nav-item { transition: all 0.2s ease; }
        @keyframes slide-up {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        .pb-safe { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans h-full">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Minus, Trash2, Edit2, RotateCcw, CreditCard, DollarSign, TrendingUp, AlertCircle, X, Tag, Cloud, RefreshCw, Calculator, ChevronDown, ChevronUp, Layers, History, Calendar, ArrowLeft, Key, LogIn, LogOut, CheckCircle, Save, AlertTriangle, Bell, ArrowUp, ArrowDown, FileCheck, CalendarClock, RefreshCcw, Globe, ExternalLink, Link as LinkIcon, Eye, EyeOff, Settings, Wallet } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, deleteDoc, updateDoc, getDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from 'firebase/firestore';

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyDraphMDkK-uXpC-PMRM75p9h_e6VYSXEQ",
            authDomain: "cards-reward.firebaseapp.com",
            projectId: "cards-reward",
            storageBucket: "cards-reward.firebasestorage.app",
            messagingSenderId: "450336524248",
            appId: "1:450336524248:web:ecf5b879698b590e6414ad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // é è¨­å¡ç‰‡è³‡æ–™
        const DEFAULT_CARDS = [
            {
                id: 1,
                name: "æ°¸è± Sport (Google Pay)",
                rewards: [
                    { name: "åŸºæœ¬å›é¥‹", rate: 1, cap: 0 },
                    { name: "é‹å‹•çå‹µ", rate: 1, cap: 5000 },
                    { name: "æŒ‡å®šæ”¯ä»˜", rate: 5, cap: 6000 }
                ],
                currentSpend: 0,
                billingDay: 25, 
                cycleType: 'month',
                color: "bg-red-500",
                tags: ["åŠ æ²¹", "é«˜éµ", "Apple Pay"]
            },
            {
                id: 2,
                name: "æ°¸è±å¤§æˆ¶ (æŒ‡å®šé€šè·¯)",
                rewards: [
                    { name: "ä»»å‹™åŠ ç¢¼", rate: 1, cap: 30000 },
                    { name: "æŒ‡å®šé€šè·¯", rate: 5, cap: 6000 }
                ],
                currentSpend: 0,
                billingDay: 25,
                cycleType: 'billing', 
                color: "bg-gray-800",
                tags: ["è¶…å•†", "é›»å½±"]
            }
        ];

        const COLORS = [
            { name: "ç´…è‰²", value: "bg-red-500" },
            { name: "è—è‰²", value: "bg-blue-500" },
            { name: "ç¶ è‰²", value: "bg-green-500" },
            { name: "ç´«è‰²", value: "bg-purple-500" },
            { name: "æ©˜è‰²", value: "bg-orange-500" },
            { name: "é»‘è‰²", value: "bg-gray-800" },
            { name: "é’è‰²", value: "bg-teal-600" },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [syncId, setSyncId] = useState(() => localStorage.getItem('card_manager_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState(''); 
            
            const [cards, setCards] = useState([]);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [view, setView] = useState('dashboard');

            // UI States
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [isSpendModalOpen, setIsSpendModalOpen] = useState(false);
            const [isSettleModalOpen, setIsSettleModalOpen] = useState(false);
            const [isHistoryEditModalOpen, setIsHistoryEditModalOpen] = useState(false);
            const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);
            
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

            const [currentEditingCard, setCurrentEditingCard] = useState(null);
            const [settleTargetCard, setSettleTargetCard] = useState(null);
            
            // History Edit State
            const [editingHistoryId, setEditingHistoryId] = useState(null);
            const [editingHistoryMonth, setEditingHistoryMonth] = useState("");
            const [editingHistoryCards, setEditingHistoryCards] = useState([]);
            const [deleteTargetId, setDeleteTargetId] = useState(null);

            const [expandedCardId, setExpandedCardId] = useState(null);
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            const [formName, setFormName] = useState("");
            const [formColor, setFormColor] = useState(COLORS[1].value);
            const [formTags, setFormTags] = useState([]); 
            const [tagInput, setTagInput] = useState(""); 
            const [formRewards, setFormRewards] = useState([]);
            const [formCurrentSpend, setFormCurrentSpend] = useState("");
            const [formBillingDay, setFormBillingDay] = useState("");
            const [formPaymentDay, setFormPaymentDay] = useState(""); 
            const [formCycleType, setFormCycleType] = useState("month");
            const [formUrl, setFormUrl] = useState("");

            const [historyFormSpend, setHistoryFormSpend] = useState("");
            const [historyFormReward, setHistoryFormReward] = useState("");

            const [selectedTag, setSelectedTag] = useState("å…¨éƒ¨");
            const [spendAmount, setSpendAmount] = useState("");
            const [isSubtractMode, setIsSubtractMode] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !syncId) { setLoading(false); return; }
                setLoading(true);
                const docRef = doc(db, 'users', syncId, 'data', 'cards_v2');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) { setCards(docSnap.data().list || []); } 
                    else { setDoc(docRef, { list: DEFAULT_CARDS }); setCards(DEFAULT_CARDS); }
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [user, syncId]);

            useEffect(() => {
                if (!user || !syncId || view !== 'history') return;
                const historyRef = collection(db, 'users', syncId, 'history');
                const q = query(historyRef, orderBy('monthStr', 'desc'));
                return onSnapshot(q, (snapshot) => {
                    setHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, [user, syncId, view]);

            const showToast = (msg, type = 'success') => {
                setToast({ show: true, message: msg, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) showToast('å¯†ç¢¼å·²è¤‡è£½'); else showToast('è¤‡è£½å¤±æ•—', 'error');
                } catch (err) { showToast('è¤‡è£½å¤±æ•—', 'error'); }
                document.body.removeChild(textArea);
            };

            const handleLogin = (e) => { e.preventDefault(); if (!tempSyncId.trim()) return showToast("è«‹è¼¸å…¥é€£å‹•å¯†ç¢¼", 'error'); setSyncId(tempSyncId.trim()); localStorage.setItem('card_manager_sync_id', tempSyncId.trim()); };
            const handleLogout = () => { if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { setSyncId(''); localStorage.removeItem('card_manager_sync_id'); setCards([]); }};

            const updateCardsData = async (newCards) => { try { await setDoc(doc(db, 'users', syncId, 'data', 'cards_v2'), { list: newCards }, { merge: true }); } catch (e) { throw e; }};
            const saveCardsToCloud = async (newCards) => { setCards(newCards); if (!user || !syncId) return; setIsSyncing(true); try { await updateCardsData(newCards); } catch (e) { showToast("å„²å­˜å¤±æ•—: " + e.message, 'error'); } finally { setIsSyncing(false); }};

            const calculateReward = (card) => {
                let totalReward = 0; const spend = parseFloat(card.currentSpend) || 0; const breakdown = [];
                let rewards = card.rewards || []; if (rewards.length === 0) rewards = [{ name: 'å›é¥‹', rate: card.highRate || 0, cap: card.limit || 0 }];
                rewards.forEach(r => {
                    const rate = parseFloat(r.rate); const cap = parseFloat(r.cap); let validSpend = spend; let isCapped = false;
                    if (cap > 0 && spend > cap) { validSpend = cap; isCapped = true; }
                    const amount = Math.floor(validSpend * (rate / 100)); totalReward += amount;
                    breakdown.push({ name: r.name, rate, cap, validSpend, amount, isCapped });
                });
                return { total: totalReward, breakdown };
            };

            const getCaps = (card) => (card.rewards || []).map(r => parseFloat(r.cap)).filter(c => c > 0).sort((a, b) => a - b);
            const getMaxCap = (card) => { const caps = getCaps(card); return caps.length > 0 ? caps[caps.length - 1] : 0; };
            const getTotalRate = (card) => (card.rewards || []).reduce((acc, cur) => acc + parseFloat(cur.rate || 0), 0);
            const allTags = ["å…¨éƒ¨", ...Array.from(new Set(cards.flatMap(c => c.tags || [])))];
            const filteredCards = selectedTag === "å…¨éƒ¨" ? cards : cards.filter(c => c.tags && c.tags.includes(selectedTag));
            const totalSpend = cards.reduce((acc, card) => acc + (parseFloat(card.currentSpend) || 0), 0);
            const totalReward = cards.reduce((acc, card) => acc + calculateReward(card).total, 0);
            const totalRate = totalSpend > 0 ? ((totalReward / totalSpend) * 100).toFixed(2) : 0;

            const getBillingInfo = (day) => {
                if (!day) return null;
                const today = new Date(); const currentDay = today.getDate();
                let daysLeft = day - currentDay; if (daysLeft < 0) daysLeft += 30; return daysLeft;
            };

            // --- çµç®—é‚è¼¯ ---
            const openSingleSettleModal = (card) => { setSettleTargetCard(card); setIsSettleModalOpen(true); };
            const openGlobalSettleModal = () => { setSettleTargetCard(null); setIsSettleModalOpen(true); };

            const handleConfirmSettle = async () => {
                const currentMonthStr = new Date().toISOString().slice(0, 7);
                setIsSyncing(true);
                try {
                    const historyDocRef = doc(collection(db, 'users', syncId, 'history'), currentMonthStr);
                    const historyDocSnap = await getDoc(historyDocRef);
                    let existingData = { totalSpend: 0, totalReward: 0, cardsSnapshot: [] };
                    if (historyDocSnap.exists()) { existingData = historyDocSnap.data(); }

                    let cardsToSettle = [];
                    if (settleTargetCard) { cardsToSettle = [settleTargetCard]; } 
                    else { cardsToSettle = cards.filter(c => c.currentSpend > 0 && (c.cycleType === 'month' || !c.cycleType)); }

                    if (cardsToSettle.length === 0) { showToast("æ²’æœ‰éœ€è¦çµç®—çš„å¡ç‰‡", 'error'); setIsSettleModalOpen(false); setIsSyncing(false); return; }

                    let newTotalSpend = existingData.totalSpend;
                    let newTotalReward = existingData.totalReward;
                    let newSnapshot = [...(existingData.cardsSnapshot || [])];

                    cardsToSettle.forEach(card => {
                        const rewardData = calculateReward(card);
                        const cardSpend = parseFloat(card.currentSpend);
                        const cardReward = rewardData.total;
                        newTotalSpend += cardSpend;
                        newTotalReward += cardReward;

                        const existingCardIndex = newSnapshot.findIndex(c => c.name === card.name); 
                        if (existingCardIndex >= 0) { newSnapshot[existingCardIndex].spend += cardSpend; newSnapshot[existingCardIndex].reward += cardReward; } 
                        else { newSnapshot.push({ name: card.name, color: card.color, spend: cardSpend, reward: cardReward }); }
                    });

                    await setDoc(historyDocRef, {
                        monthStr: currentMonthStr, totalSpend: newTotalSpend, totalReward: newTotalReward, timestamp: new Date().toISOString(), cardsSnapshot: newSnapshot
                    });

                    let updatedCards = [...cards];
                    if (settleTargetCard) { updatedCards = cards.map(c => c.id === settleTargetCard.id ? { ...c, currentSpend: 0 } : c); } 
                    else { updatedCards = cards.map(c => (c.cycleType === 'month' || !c.cycleType) ? { ...c, currentSpend: 0 } : c); }
                    
                    setCards(updatedCards); await updateCardsData(updatedCards);
                    
                    setIsSettleModalOpen(false); showToast(settleTargetCard ? `${settleTargetCard.name} å·²çµç®—` : "æœˆåˆ¶å¡ç‰‡å·²çµç®—"); setSettleTargetCard(null);
                } catch (e) { console.error("Settle error:", e); showToast(`çµç®—å¤±æ•—ï¼š${e.message}`, 'error'); } finally { setIsSyncing(false); }
            };

            const getYearlySummary = () => { const s = {}; history.forEach(i => { const y = i.monthStr.slice(0, 4); if (!s[y]) s[y] = { spend: 0, reward: 0 }; s[y].spend += i.totalSpend; s[y].reward += i.totalReward; }); return Object.entries(s).sort((a, b) => b[0] - a[0]); };
            const handleSaveCard = () => { 
                if (!formName) return showToast("è«‹è¼¸å…¥åç¨±", 'error'); 
                const cleanRewards = formRewards.filter(r => r.name && r.rate).map(r => ({ name: r.name, rate: parseFloat(r.rate), cap: parseFloat(r.cap) || 0 })); 
                const newCardData = { 
                    id: currentEditingCard ? currentEditingCard.id : Date.now(), 
                    name: formName, rewards: cleanRewards, color: formColor, tags: formTags, 
                    currentSpend: parseFloat(formCurrentSpend) || 0, 
                    billingDay: parseInt(formBillingDay) || 0, paymentDay: parseInt(formPaymentDay) || 0, cycleType: formCycleType,
                    officialUrl: formUrl 
                }; 
                saveCardsToCloud(currentEditingCard ? cards.map(c => c.id === currentEditingCard.id ? newCardData : c) : [...cards, newCardData]); 
                closeEditModal(); showToast("å¡ç‰‡å·²å„²å­˜"); 
            };
            const handleDeleteCard = (id) => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿ")) { saveCardsToCloud(cards.filter(c => c.id !== id)); closeEditModal(); showToast("å¡ç‰‡å·²åˆªé™¤"); }};
            const handleAddSpend = () => { const amt = parseFloat(spendAmount); if (isNaN(amt) || !currentEditingCard) return; const finalAmt = isSubtractMode ? -amt : amt; saveCardsToCloud(cards.map(c => c.id === currentEditingCard.id ? { ...c, currentSpend: Math.max(0, c.currentSpend + finalAmt) } : c)); closeSpendModal(); showToast(isSubtractMode ? "é‡‘é¡å·²æ‰£é™¤" : "è¨˜å¸³æˆåŠŸ"); };
            const handleAddTag = () => { if (tagInput && !formTags.includes(tagInput)) { setFormTags([...formTags, tagInput]); setTagInput(""); }};
            const handleRewardChange = (i, f, v) => { const n = [...formRewards]; n[i][f] = v; setFormRewards(n); };
            const removeRewardRow = (index) => { setFormRewards(prev => prev.filter((_, i) => i !== index)); };
            const handleMoveCard = (direction) => {
                if (!currentEditingCard) return; const index = cards.findIndex(c => c.id === currentEditingCard.id); if (index === -1) return; const newCards = [...cards];
                if (direction === 'up' && index > 0) { [newCards[index - 1], newCards[index]] = [newCards[index], newCards[index - 1]]; } 
                else if (direction === 'down' && index < cards.length - 1) { [newCards[index + 1], newCards[index]] = [newCards[index], newCards[index + 1]]; } 
                else { return; } saveCardsToCloud(newCards);
            };
            const openEditModal = (card = null) => { 
                setCurrentEditingCard(card); setFormName(card?.name||""); setFormColor(card?.color||COLORS[1].value); setFormTags(card?.tags||[]); 
                setFormRewards(card?.rewards || [{ name: 'åŸºæœ¬å›é¥‹', rate: '1', cap: '0' }, { name: 'æŒ‡å®šåŠ ç¢¼', rate: '', cap: '' }]); 
                setFormCurrentSpend(card?.currentSpend || 0); setFormBillingDay(card?.billingDay || ""); setFormPaymentDay(card?.paymentDay || "");
                setFormCycleType(card?.cycleType || "month"); setFormUrl(card?.officialUrl || ""); 
                setIsEditModalOpen(true); 
            };
            const openSpendModal = (card) => { setCurrentEditingCard(card); setSpendAmount(""); setIsSubtractMode(false); setIsSpendModalOpen(true); };
            const closeEditModal = () => setIsEditModalOpen(false);
            const closeSpendModal = () => setIsSpendModalOpen(false);
            const toggleExpand = (cardId) => setExpandedCardId(expandedCardId === cardId ? null : cardId);

            // History & Delete Functions
            const openHistoryEditModal = (item) => { setEditingHistoryId(item.id); setEditingHistoryMonth(item.monthStr); setEditingHistoryCards(JSON.parse(JSON.stringify(item.cardsSnapshot || []))); setIsHistoryEditModalOpen(true); };
            const confirmDeleteHistory = (id) => { setDeleteTargetId(id); setIsDeleteConfirmOpen(true); };
            const executeDeleteHistory = async () => { if (!deleteTargetId) return; setIsSyncing(true); try { await deleteDoc(doc(db, 'users', syncId, 'history', deleteTargetId)); setIsDeleteConfirmOpen(false); setDeleteTargetId(null); showToast("ç´€éŒ„å·²åˆªé™¤"); } catch (e) { showToast("åˆªé™¤å¤±æ•—", 'error'); } finally { setIsSyncing(false); } };
            const handleUpdateHistory = async () => { if (!editingHistoryId) return; setIsSyncing(true); const newTotalSpend = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.spend) || 0), 0); const newTotalReward = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.reward) || 0), 0); try { await updateDoc(doc(db, 'users', syncId, 'history', editingHistoryId), { totalSpend: newTotalSpend, totalReward: newTotalReward, cardsSnapshot: editingHistoryCards }); setIsHistoryEditModalOpen(false); showToast("ä¿®æ­£å®Œæˆ"); } catch (e) { showToast("æ›´æ–°å¤±æ•—", 'error'); } finally { setIsSyncing(false); } };
            const handleHistoryCardChange = (index, field, value) => { setEditingHistoryCards(prev => prev.map((item, i) => i === index ? { ...item, [field]: parseFloat(value) || 0 } : item)); };
            const handleHistoryCardDelete = (idx) => { if(confirm("åˆªé™¤é€™ç­†å¡ç‰‡ç´€éŒ„ï¼Ÿ")) setEditingHistoryCards(prev => prev.filter((_, i) => i !== idx)); };
            const editingTotalSpend = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.spend) || 0), 0);
            const editingTotalReward = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.reward) || 0), 0);

            // --- Schedule Logic ---
            const getNextDate = (day) => {
                if (!day) return null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let targetDate = new Date(today.getFullYear(), today.getMonth(), day);
                while(targetDate.getMonth() !== today.getMonth()) { targetDate.setDate(targetDate.getDate() - 1); }
                if (targetDate < today) { targetDate = new Date(today.getFullYear(), today.getMonth() + 1, day); while(targetDate.getMonth() !== (today.getMonth() + 1) % 12) { targetDate.setDate(targetDate.getDate() - 1); } }
                return targetDate;
            };

            const getScheduleItems = () => {
                const eventMap = {}; 
                cards.forEach(card => {
                    const billingDate = getNextDate(card.billingDay);
                    const paymentDate = getNextDate(card.paymentDay);
                    const today = new Date(); today.setHours(0,0,0,0);
                    
                    if (billingDate) {
                        const dateStr = billingDate.toISOString().split('T')[0];
                        const key = `${dateStr}_billing`;
                        if (!eventMap[key]) {
                            eventMap[key] = {
                                id: key, type: 'billing', date: billingDate,
                                daysLeft: Math.ceil((billingDate - today) / (1000 * 60 * 60 * 24)), cards: []
                            };
                        }
                        eventMap[key].cards.push(card);
                    }

                    if (paymentDate) {
                        const dateStr = paymentDate.toISOString().split('T')[0];
                        const key = `${dateStr}_payment`;
                        if (!eventMap[key]) {
                            eventMap[key] = {
                                id: key, type: 'payment', date: paymentDate,
                                daysLeft: Math.ceil((paymentDate - today) / (1000 * 60 * 60 * 24)), cards: []
                            };
                        }
                        eventMap[key].cards.push(card);
                    }
                });
                return Object.values(eventMap).sort((a, b) => a.daysLeft - b.daysLeft);
            };

            if (!syncId) return <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6"><div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center"><div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Key className="w-8 h-8 text-blue-600" /></div><h1 className="text-2xl font-bold text-gray-800 mb-2">è¼¸å…¥é€£å‹•å¯†ç¢¼</h1><p className="text-gray-500 text-sm mb-6">è«‹åœ¨ä¸åŒè£ç½®è¼¸å…¥ç›¸åŒçš„å¯†ç¢¼ï¼Œå³å¯åŒæ­¥æ‚¨çš„è¨˜å¸³è³‡æ–™ã€‚</p><form onSubmit={handleLogin} className="space-y-4"><div className="relative"><input type="text" value={tempSyncId} onChange={(e) => setTempSyncId(e.target.value)} placeholder="ä¾‹å¦‚ï¼šmy-secret-123" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none text-center text-lg bg-gray-50" inputMode="text" /></div><button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition active:scale-95 flex items-center justify-center gap-2"><LogIn className="w-5 h-5" /> é–‹å§‹ä½¿ç”¨</button></form></div></div>;
            if (loading) return <div className="min-h-screen flex items-center justify-center text-gray-400">è®€å–è³‡æ–™ä¸­...</div>;

            // --- Render Views ---
            let content;
            if (view === 'settings') {
                content = (
                    <div className="pb-safe pt-safe bg-gray-50 min-h-screen">
                        <div className="bg-white px-6 pt-8 pb-4 shadow-sm mb-4">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Settings className="w-6 h-6 text-gray-600" />è¨­å®š</h1>
                        </div>
                        <div className="px-4 space-y-4">
                            <div className="bg-white rounded-2xl p-4 shadow-sm">
                                <div className="text-sm text-gray-500 mb-1">ç›®å‰é€£å‹•å¯†ç¢¼</div>
                                <div className="text-lg font-mono font-bold bg-gray-100 p-2 rounded flex justify-between items-center">
                                    {syncId}
                                    <button onClick={() => copyToClipboard(syncId)} className="text-blue-600 text-sm">è¤‡è£½</button>
                                </div>
                            </div>
                            
                            {/* æœˆçµç®—æŒ‰éˆ•ç§»åˆ°é€™è£¡ */}
                            <div className="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between">
                                <div>
                                    <div className="font-bold text-gray-800">æ—¥æ›†æœˆçµç®—</div>
                                    <div className="text-xs text-gray-500">æ¯æœˆ 1 è™Ÿé‡ç½®æ‰€æœ‰æœˆåˆ¶å¡ç‰‡</div>
                                </div>
                                <button onClick={openGlobalSettleModal} className="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold">åŸ·è¡Œ</button>
                            </div>

                            <button onClick={handleLogout} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-8">
                                <LogOut className="w-5 h-5" /> ç™»å‡º / åˆ‡æ›å¸³è™Ÿ
                            </button>
                        </div>
                        <div className="h-24"></div>
                    </div>
                );
            } else if (view === 'schedule') {
                const scheduleItems = getScheduleItems();
                content = (
                    <div className="px-4 py-4 space-y-4">
                        <div className="text-lg font-bold text-gray-800 mb-2 px-1">ç¹³è²»æ—¥ç¨‹</div>
                        {scheduleItems.length === 0 ? <div className="text-center py-10 text-gray-400"><p>å°šæœªè¨­å®šæ—¥æœŸ</p></div> : scheduleItems.map(item => (
                            <div key={item.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center justify-between">
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <div className="flex flex-col gap-1">{item.cards.map((card, idx) => (<div key={idx} className={`w-1.5 h-6 rounded-full ${card.color}`}></div>))}</div>
                                    <div className="flex-1 min-w-0">
                                        <div className="font-bold text-gray-800 flex flex-wrap items-center gap-2"><span className="truncate">{item.cards.map(c => c.name).join('ã€')}</span><span className={`text-xs px-2 py-0.5 rounded-full whitespace-nowrap flex-shrink-0 ${item.type === 'payment' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{item.type === 'payment' ? 'ç¹³æ¬¾' : 'çµå¸³'}</span></div>
                                        <div className="text-sm text-gray-500 mt-0.5">{item.date.getMonth() + 1}/{item.date.getDate()} {item.type === 'payment' ? 'æˆªæ­¢' : 'çµç®—'} <span className="text-xs ml-1 text-gray-400">(å…± {item.cards.length} å¼µ)</span></div>
                                    </div>
                                </div>
                                <div className="text-right flex-shrink-0 pl-2"><div className={`text-xl font-bold ${item.daysLeft <= 3 ? 'text-red-500' : 'text-gray-800'}`}>{item.daysLeft} <span className="text-xs font-normal text-gray-500">å¤©å¾Œ</span></div>{item.daysLeft <= 3 && <div className="text-xs text-red-500 font-bold flex items-center justify-end gap-1"><AlertCircle className="w-3 h-3"/> æ€¥</div>}</div>
                            </div>
                        ))}
                    </div>
                );
            } else if (view === 'history') {
                const yearlySummary = getYearlySummary();
                content = (
                    <div className="px-4 py-4 space-y-4">
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg"><h2 className="font-bold text-lg mb-3 flex items-center gap-2"><Calendar className="w-5 h-5"/> å¹´åº¦ç¸½çµ</h2>{yearlySummary.length===0?<p className="opacity-70">å°šç„¡ç´€éŒ„</p> : yearlySummary.map(([y, d]) => (<div key={y} className="flex justify-between border-b border-white/20 pb-2 mb-2 last:border-0"><span className="font-bold">{y}</span><div className="text-right"><div>${d.spend.toLocaleString()}</div><div className="text-xs bg-white/20 px-2 rounded-full">å›é¥‹ ${d.reward.toLocaleString()}</div></div></div>))}</div>
                        {history.map(h => (
                            <div key={h.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                                <div onClick={() => setExpandedHistoryId(expandedHistoryId === h.id ? null : h.id)} className="flex justify-between items-center cursor-pointer"><div className="font-bold text-lg text-gray-800">{h.monthStr} <span className="text-sm font-normal text-gray-500 ml-2">${h.totalSpend.toLocaleString()}</span></div><ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${expandedHistoryId === h.id ? 'rotate-180' : ''}`} /></div>
                                {expandedHistoryId === h.id && (<div className="mt-3 pt-3 border-t border-gray-100 space-y-2">{h.cardsSnapshot?.map((c, i) => (<div key={i} className="flex justify-between text-sm"><div className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${c.color}`}></span><span>{c.name}</span></div><div className="text-right"><div>${c.spend.toLocaleString()}</div><div className="text-xs text-green-600">+${c.reward}</div></div></div>))}<div className="flex gap-3 pt-2 mt-4 border-t border-gray-100"><button onClick={(e) => { e.stopPropagation(); openHistoryEditModal(h); }} className="flex-1 py-2 text-sm text-blue-600 bg-blue-50 rounded-lg flex items-center justify-center gap-1 hover:bg-blue-100 transition"><Edit2 className="w-3 h-3" /> ä¿®æ”¹ç´°é …</button><button onClick={(e) => { e.stopPropagation(); confirmDeleteHistory(h.id); }} className="flex-1 py-2 text-sm text-red-600 bg-red-50 rounded-lg flex items-center justify-center gap-1 hover:bg-red-100 transition"><Trash2 className="w-3 h-3" /> åˆªé™¤ç´€éŒ„</button></div></div>)}
                            </div>
                        ))}
                    </div>
                );
            } else {
                // Dashboard
                content = (
                    <div>
                        <div className="bg-white px-6 pt-12 pb-4 shadow-sm sticky top-0 z-20">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-2xl font-extrabold text-gray-800 flex items-center gap-2 tracking-tight"><Wallet className="w-7 h-7 text-blue-600" /> ä¿¡ç”¨å¡ç®¡å®¶ {isSyncing && <RefreshCw className="w-4 h-4 animate-spin text-gray-400"/>}</h1>
                            </div>
                            <div className="grid grid-cols-2 gap-3 mb-4"><div className="bg-blue-50 p-3 rounded-2xl border border-blue-100"><div className="text-blue-600 text-xs mb-1 font-medium flex items-center gap-1"><DollarSign className="w-3 h-3"/>æœ¬æœˆç¸½åˆ·</div><div className="text-xl font-bold text-blue-900">${totalSpend.toLocaleString()}</div></div><div className="bg-green-50 p-3 rounded-2xl border border-green-100"><div className="text-green-600 text-xs mb-1 font-medium flex items-center gap-1"><TrendingUp className="w-3 h-3"/>é ä¼°å›é¥‹</div><div className="text-xl font-bold text-green-900">${totalReward.toLocaleString()} <span className="text-xs font-normal">({totalRate}%)</span></div></div></div>
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2">{allTags.map(t => <button key={t} onClick={() => setSelectedTag(t)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition ${selectedTag === t ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-gray-100 text-gray-500'}`}>{t}</button>)}</div>
                        </div>

                        <div className="px-4 py-4 space-y-4 pb-24">
                            {filteredCards.length === 0 && <div className="text-center py-10 text-gray-400"><div className="bg-white inline-block p-4 rounded-full mb-3 shadow-sm"><CreditCard className="w-8 h-8 text-gray-300"/></div><p>é»æ“Šå³ä¸‹è§’ + æ–°å¢å¡ç‰‡</p></div>}
                            {filteredCards.map(card => {
                                const caps = getCaps(card); const maxCap = caps.length > 0 ? caps[caps.length - 1] : 0;
                                const spend = card.currentSpend; const percentage = maxCap === 0 ? 0 : Math.min((spend / maxCap) * 100, 100);
                                const isOverLimit = maxCap > 0 && spend >= maxCap; const { total: reward, breakdown } = calculateReward(card);
                                const isExpanded = expandedCardId === card.id;
                                const daysLeft = getBillingInfo(card.billingDay);
                                const isUrgent = daysLeft !== null && daysLeft <= 3 && daysLeft >= 0;
                                const isCycle = card.cycleType === 'billing';

                                return (
                                    <div key={card.id} className="bg-white rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden group transition-all active:scale-[0.99] duration-200">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${card.color}`}></div>
                                        <div className="p-5 pb-3" onClick={() => openSpendModal(card)}>
                                            <div className="flex justify-between items-start mb-2 pl-2">
                                                <div>
                                                    <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">{card.name} {isOverLimit && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full flex items-center gap-1"><AlertCircle className="w-3 h-3"/> å·²æ»¿</span>}{card.officialUrl && (<a href={card.officialUrl} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="ml-1 text-gray-400 hover:text-blue-500 p-1"><Globe className="w-4 h-4" /></a>)}</h3>
                                                    <div className="text-sm text-gray-500 mt-0.5 flex flex-wrap items-center gap-2"><span>{maxCap > 0 ? (caps.length > 1 ? `åˆ†æ®µä¸Šé™ $${maxCap.toLocaleString()}` : `ä¸Šé™ $${maxCap.toLocaleString()}`) : 'ç„¡ä¸Šé™'} <span className="text-gray-300 mx-1">|</span> æœ€é«˜ {getTotalRate(card)}%</span>{card.billingDay && (<span className={`flex items-center gap-1 px-1.5 py-0.5 rounded text-xs ${isUrgent ? 'bg-orange-100 text-orange-600 font-bold' : 'bg-gray-100 text-gray-500'}`}><Calendar className="w-3 h-3" /> {card.billingDay}æ—¥çµ {isUrgent && `(å‰©${daysLeft}å¤©)`}</span>)}</div>
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); openEditModal(card); }} className="text-gray-400 p-2 hover:text-gray-600"><Edit2 className="w-4 h-4" /></button>
                                            </div>
                                            <div className="pl-2 mb-3 flex flex-wrap gap-1.5">{card.tags?.map(t => <span key={t} className="text-xs px-2 py-0.5 bg-gray-50 text-gray-500 rounded-md border border-gray-100">#{t}</span>)}</div>
                                            <div className="pl-2">
                                                <div className="flex justify-between items-end mb-1"><div className="text-2xl font-bold text-gray-900">${spend.toLocaleString()}</div><div className="text-right text-green-600 font-bold text-lg">+${reward}</div></div>
                                                <div className="relative w-full h-2.5 bg-gray-100 rounded-full overflow-hidden mb-2"><div className={`h-full rounded-full transition-all duration-500 ${isOverLimit ? 'bg-red-500' : card.color.replace('bg-', 'bg-')}`} style={{ width: `${percentage}%` }}></div>{caps.map((cap, i) => { if (cap >= maxCap) return null; const tickPos = (cap / maxCap) * 100; return <div key={i} className="absolute top-0 bottom-0 w-0.5 bg-white opacity-70 z-10 shadow-sm" style={{ left: `${tickPos}%` }}></div> })}</div>
                                                {maxCap > 0 && <div className="flex justify-between text-xs text-gray-400"><span>å·²ç”¨ {percentage.toFixed(0)}%</span><span>å‰©é¤˜: <span className={spend >= maxCap ? 'text-red-500 font-bold' : ''}>${Math.max(0, maxCap - spend).toLocaleString()}</span></span></div>}
                                            </div>
                                        </div>
                                        <div className={`bg-gray-50 border-t border-gray-100 transition-all duration-300 overflow-hidden ${isExpanded ? 'max-h-96' : 'max-h-0'}`}>
                                            <div className="p-4 pl-6 text-sm space-y-2">
                                                <div className="text-xs text-gray-400 font-bold mb-2 uppercase tracking-wide">å›é¥‹æ˜ç´°</div>
                                                {breakdown.map((b, i) => (<div key={i} className="flex justify-between items-center"><div className="flex flex-col"><span className="font-medium">{b.name} {b.isCapped && <span className="text-[10px] text-red-500 bg-red-50 px-1 rounded">æ»¿</span>}</span><span className="text-xs text-gray-400">{b.cap>0?`ä¸Šé™ $${b.cap.toLocaleString()}`:'ç„¡ä¸Šé™'}</span></div><div className="text-right"><div className="font-mono font-bold">+${b.amount}</div><div className="text-xs text-gray-400">${b.validSpend.toLocaleString()} Ã— {b.rate}%</div></div></div>))}
                                                <div className="border-t border-gray-200 mt-2 pt-2 flex justify-between font-bold text-gray-800"><span>ç¸½è¨ˆ</span><span className="text-green-600">+${reward}</span></div>
                                            </div>
                                        </div>
                                        <div className="flex border-t border-gray-100 divide-x divide-gray-100">
                                            <button onClick={() => toggleExpand(card.id)} className="flex-1 py-3 flex items-center justify-center gap-1 text-gray-500 text-sm font-medium hover:bg-gray-50 transition">{isExpanded ? <span>æ”¶èµ· <ChevronUp className="w-4 h-4 inline"/></span> : <span>ç®—å¼ <ChevronDown className="w-4 h-4 inline"/></span>}</button>
                                            <button onClick={() => openSingleSettleModal(card)} className="flex-1 py-3 flex items-center justify-center gap-1 text-gray-500 text-sm font-medium hover:bg-gray-50 transition hover:text-red-500"><FileCheck className="w-4 h-4"/> çµç®—</button>
                                            <button onClick={() => openSpendModal(card)} className={`flex-1 py-3 flex items-center justify-center gap-2 text-white font-medium transition active:scale-95 ${card.color}`}><Plus className="w-4 h-4" /> è¨˜å¸³</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* FAB Add Button */}
                        <button onClick={() => openEditModal()} className="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-blue-700 active:scale-90 transition-transform z-30">
                            <Plus className="w-8 h-8" />
                        </button>
                    </div>
                );
            }

            // --- Main Layout ---
            return (
                <div className="min-h-screen bg-gray-50 pb-safe">
                    {/* View Content */}
                    <div className="pb-24"> {/* Increased padding to avoid nav bar overlap */}
                        {content}
                    </div>

                    {/* Bottom Navigation Bar */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center pb-safe pt-2 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center p-2 w-full nav-item ${view === 'dashboard' ? 'nav-item-active' : 'text-gray-400'}`}>
                            <CreditCard className="w-6 h-6" />
                            <span className="text-[10px] mt-1 font-medium">å¡ç‰‡</span>
                        </button>
                        <button onClick={() => setView('schedule')} className={`flex flex-col items-center p-2 w-full nav-item ${view === 'schedule' ? 'nav-item-active' : 'text-gray-400'}`}>
                            <CalendarClock className="w-6 h-6" />
                            <span className="text-[10px] mt-1 font-medium">æ—¥ç¨‹</span>
                        </button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center p-2 w-full nav-item ${view === 'history' ? 'nav-item-active' : 'text-gray-400'}`}>
                            <History className="w-6 h-6" />
                            <span className="text-[10px] mt-1 font-medium">ç´€éŒ„</span>
                        </button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center p-2 w-full nav-item ${view === 'settings' ? 'nav-item-active' : 'text-gray-400'}`}>
                            <Settings className="w-6 h-6" />
                            <span className="text-[10px] mt-1 font-medium">è¨­å®š</span>
                        </button>
                    </div>

                    {/* Modals & Toasts */}
                    {isSettleModalOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center"><div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle className="w-8 h-8 text-blue-600" /></div><h2 className="text-2xl font-bold text-gray-800 mb-1">{settleTargetCard ? `ç¢ºèªçµç®— ${settleTargetCard.name}ï¼Ÿ` : "ç¢ºèªé€²è¡Œæœˆçµç®—ï¼Ÿ"}</h2><p className="text-sm text-gray-500 mb-6">{settleTargetCard ? <span>å°‡ <span className="font-bold text-blue-600">{settleTargetCard.name}</span> çš„é‡‘é¡ç´¯å…¥æ­·å²ï¼Œä¸¦æ­¸é›¶é¡åº¦ã€‚</span> : <span>å°‡æ‰€æœ‰ <span className="font-bold text-blue-600">æ—¥æ›†æœˆåˆ¶</span> å¡ç‰‡é‡‘é¡ç´¯å…¥æ­·å²ï¼Œä¸¦æ­¸é›¶é¡åº¦ã€‚<br/><span className="text-xs text-orange-500">(é€±æœŸåˆ¶å¡ç‰‡ä¸æœƒå—åˆ°å½±éŸ¿)</span></span>}</p><div className="flex gap-3"><button onClick={() => setIsSettleModalOpen(false)} className="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">å–æ¶ˆ</button><button onClick={handleConfirmSettle} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">{isSyncing ? <RefreshCw className="w-5 h-5 animate-spin" /> : "ç¢ºèªçµç®—"}</button></div></div></div>)}
                    {isEditModalOpen && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto animate-fade-in"><div className="bg-white rounded-3xl w-full max-w-sm p-6 space-y-4 my-auto shadow-2xl"><div className="flex justify-between items-center"><h3 className="font-bold text-lg">å¡ç‰‡è¨­å®š</h3><button onClick={closeEditModal}><X className="w-6 h-6 text-gray-400" /></button></div><input type="text" value={formName} onChange={(e) => setFormName(e.target.value)} placeholder="å¡ç‰‡åç¨±" className="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500" /><div className="bg-blue-50 p-3 rounded-xl border border-blue-100"><label className="block text-xs font-bold text-blue-700 mb-1">ç›®å‰å·²åˆ·é‡‘é¡ (æ‰‹å‹•ä¿®æ­£)</label><div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span><input type="number" value={formCurrentSpend} onChange={(e) => setFormCurrentSpend(e.target.value)} className="w-full pl-7 pr-3 py-2 rounded-lg border border-blue-200 text-blue-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" inputMode="decimal" /></div></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">å®˜æ–¹å›é¥‹æŸ¥è©¢ç¶²å€ (é¸å¡«)</label><div className="flex gap-2"><input type="url" value={formUrl} onChange={(e) => setFormUrl(e.target.value)} placeholder="https://..." className="flex-1 px-4 py-2 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 text-sm" /><a href={formUrl} target="_blank" rel="noopener noreferrer" className={`flex items-center justify-center w-10 h-10 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-100 ${!formUrl ? 'pointer-events-none opacity-50' : ''}`}><ExternalLink className="w-5 h-5" /></a></div></div>
                        <div className="grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100"><div className="col-span-2 text-sm font-bold text-gray-700 mb-1">å›é¥‹é€±æœŸé¡å‹</div><label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer ${formCycleType === 'month' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-gray-200'}`}><input type="radio" name="cycleType" value="month" checked={formCycleType === 'month'} onChange={(e) => setFormCycleType(e.target.value)} className="w-4 h-4 text-blue-600" /><span className="text-sm">ğŸ“… æœˆåˆ¶ (1è™Ÿ)</span></label><label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer ${formCycleType === 'billing' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-gray-200'}`}><input type="radio" name="cycleType" value="billing" checked={formCycleType === 'billing'} onChange={(e) => setFormCycleType(e.target.value)} className="w-4 h-4 text-blue-600" /><span className="text-sm">ğŸ”„ é€±æœŸåˆ¶</span></label></div>
                        <div className="flex gap-3"><div className="flex-1"><label className="block text-sm font-medium text-gray-700 mb-1">çµå¸³æ—¥ (è™Ÿ)</label><input type="number" value={formBillingDay} onChange={(e) => setFormBillingDay(e.target.value)} placeholder="25" min="1" max="31" className="w-full px-4 py-2 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500" /></div><div className="flex-1"><label className="block text-sm font-medium text-gray-700 mb-1">æˆªæ­¢æ—¥ (è™Ÿ)</label><input type="number" value={formPaymentDay} onChange={(e) => setFormPaymentDay(e.target.value)} placeholder="10" min="1" max="31" className="w-full px-4 py-2 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500" /></div></div>
                        <div><div className="flex justify-between mb-2 text-sm font-medium text-gray-700"><span>å›é¥‹è¦å‰‡</span><button onClick={() => setFormRewards([...formRewards, {name:'', rate:'', cap:''}])} className="text-blue-600 text-xs font-bold bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button></div><div className="space-y-2">{formRewards.map((r, i) => (<div key={i} className="flex flex-col gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100"><div className="flex gap-2"><input value={r.name} onChange={(e)=>handleRewardChange(i,'name',e.target.value)} placeholder="åç¨±" className="flex-1 px-2 py-1 text-sm rounded border border-gray-200 outline-none"/><button onClick={()=>{const n=[...formRewards];n.splice(i,1);removeRewardRow(i)}}><X className="w-4 h-4 text-gray-400"/></button></div><div className="flex gap-2"><div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">%</span><input type="number" value={r.rate} onChange={(e)=>handleRewardChange(i,'rate',e.target.value)} placeholder="%" className="w-full pl-6 pr-2 py-1 text-sm rounded border border-gray-200 outline-none" inputMode="decimal"/></div><div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">é™</span><input type="number" value={r.cap} onChange={(e)=>handleRewardChange(i,'cap',e.target.value)} placeholder="0" className="w-full pl-6 pr-2 py-1 text-sm rounded border border-gray-200 outline-none" inputMode="decimal"/></div></div></div>))}</div></div><div><div className="mb-2 text-sm font-medium text-gray-700">é¡è‰²</div><div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{COLORS.map(c => <button key={c.value} onClick={() => setFormColor(c.value)} className={`w-6 h-6 rounded-full flex-shrink-0 ${c.value} ${formColor === c.value ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''}`} />)}</div></div><div><div className="mb-2 text-sm font-medium text-gray-700">æ¨™ç±¤</div><div className="flex gap-2 mb-2"><input value={tagInput} onChange={(e) => setTagInput(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter')handleAddTag(e)}} placeholder="æ–°å¢æ¨™ç±¤" className="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none"/><button onClick={handleAddTag} className="bg-gray-800 text-white px-3 py-2 rounded-lg text-sm">æ–°å¢</button></div><div className="flex flex-wrap gap-2">{formTags.map(t => <span key={t} className="px-2 py-1 bg-gray-100 rounded text-xs flex items-center gap-1 border border-gray-200">{t} <button onClick={()=>setFormTags(formTags.filter(tg=>tg!==t))}><X className="w-3 h-3"/></button></span>)}</div></div>
                    {/* æ’åºèˆ‡å‹•ä½œæŒ‰éˆ• */}
                    <div className="pt-2 border-t border-gray-100 space-y-3">
                        <div className="flex gap-2">
                            <button onClick={() => handleMoveCard('up')} className="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg flex items-center justify-center gap-1 text-sm font-medium hover:bg-gray-200"><ArrowUp className="w-4 h-4"/> ä¸Šç§»</button>
                            <button onClick={() => handleMoveCard('down')} className="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg flex items-center justify-center gap-1 text-sm font-medium hover:bg-gray-200"><ArrowDown className="w-4 h-4"/> ä¸‹ç§»</button>
                        </div>
                        <div className="flex gap-3">
                            {currentEditingCard && <button onClick={() => handleDeleteCard(currentEditingCard.id)} className="p-3 text-red-500 bg-red-50 rounded-xl hover:bg-red-100"><Trash2 className="w-5 h-5" /></button>}
                            <button onClick={handleSaveCard} className="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition">å„²å­˜</button>
                        </div>
                    </div>
                    </div></div>)}
                    
                    {isSpendModalOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><div><div className="text-sm text-gray-500">æ–°å¢æ¶ˆè²»</div><h3 className="font-bold text-xl flex items-center gap-2"><span className={`w-3 h-3 rounded-full ${currentEditingCard?.color}`}></span>{currentEditingCard?.name}</h3></div><button onClick={closeSpendModal} className="bg-gray-100 p-2 rounded-full"><X className="w-5 h-5" /></button></div><div className="flex bg-gray-100 rounded-xl p-1 mb-4"><button onClick={() => setIsSubtractMode(false)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${!isSubtractMode ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'}`}>å¢åŠ  (+)</button><button onClick={() => setIsSubtractMode(true)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${isSubtractMode ? 'bg-red-500 text-white shadow-sm' : 'text-gray-500'}`}>æ¸›å°‘ (-/é€€æ¬¾)</button></div><div className="relative mb-6"><span className={`absolute left-4 top-1/2 -translate-y-1/2 text-3xl font-bold ${isSubtractMode ? 'text-red-500' : 'text-gray-400'}`}>{isSubtractMode ? '-' : '$'}</span><input type="number" autoFocus value={spendAmount} onChange={(e) => setSpendAmount(e.target.value)} placeholder="0" className={`w-full pl-10 pr-4 py-4 text-4xl font-bold text-center bg-gray-50 rounded-2xl border-2 border-transparent focus:bg-white outline-none transition ${isSubtractMode ? 'text-red-600 focus:border-red-500' : 'text-gray-900 focus:border-blue-500'}`} inputMode="decimal" /></div><div className="grid grid-cols-4 gap-3 mb-6">{[100, 500, 1000, 5000].map(amt => <button key={amt} onClick={() => setSpendAmount((prev) => String((parseFloat(prev) || 0) + amt))} className="bg-gray-100 text-gray-600 text-sm font-medium py-2 rounded-lg hover:bg-gray-200 transition">+{amt}</button>)}</div><button onClick={handleAddSpend} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg shadow-blue-500/30 transition active:scale-95 ${isSubtractMode ? 'bg-red-500 hover:bg-red-600' : currentEditingCard?.color}`}>{isSubtractMode ? 'ç¢ºèªæ‰£é™¤' : 'ç¢ºèªè¨˜å¸³'}</button></div></div>)}
                    {isHistoryEditModalOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto animate-fade-in"><div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl my-auto"><div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-3"><h3 className="font-bold text-lg text-gray-800">ä¿®æ”¹æ˜ç´° ({editingHistoryMonth})</h3><button onClick={() => setIsHistoryEditModalOpen(false)}><X className="w-6 h-6 text-gray-400" /></button></div><div className="bg-gray-50 rounded-xl p-3 mb-4 flex justify-between items-center"><div className="text-center flex-1 border-r border-gray-200"><div className="text-xs text-gray-500">ç¸½æ¶ˆè²» (è‡ªå‹•)</div><div className="font-bold text-lg">${editingTotalSpend.toLocaleString()}</div></div><div className="text-center flex-1"><div className="text-xs text-gray-500">ç¸½å›é¥‹ (è‡ªå‹•)</div><div className="font-bold text-lg text-green-600">+${editingTotalReward.toLocaleString()}</div></div></div><div className="space-y-3 max-h-64 overflow-y-auto pr-1">{editingHistoryCards.map((card, index) => (<div key={index} className="bg-white border border-gray-200 rounded-xl p-3"><div className="flex items-center gap-2 mb-2 font-medium text-sm text-gray-700"><span className={`w-2 h-2 rounded-full ${card.color}`}></span>{card.name}<button onClick={() => handleHistoryCardDelete(index)} className="ml-auto text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></div><div className="flex gap-2"><div className="flex-1"><label className="text-[10px] text-gray-400 block mb-0.5">æ¶ˆè²»</label><input type="number" value={card.spend} onChange={(e) => handleHistoryCardChange(index, 'spend', e.target.value)} className="w-full px-2 py-1.5 text-sm border border-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-500" inputMode="decimal" /></div><div className="flex-1"><label className="text-[10px] text-gray-400 block mb-0.5">å›é¥‹é‡‘</label><input type="number" value={card.reward} onChange={(e) => handleHistoryCardChange(index, 'reward', e.target.value)} className="w-full px-2 py-1.5 text-sm border border-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-green-500 text-green-600 font-bold" inputMode="decimal" /></div></div></div>))}{editingHistoryCards.length === 0 && <p className="text-center text-gray-400 text-sm py-4">ç„¡å¡ç‰‡ç´€éŒ„</p>}</div><div className="mt-4 pt-3 border-t border-gray-100"><button onClick={handleUpdateHistory} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 flex items-center justify-center gap-2"><Save className="w-4 h-4" /> å„²å­˜ä¿®æ”¹</button></div></div></div>)}
                    {isDeleteConfirmOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center"><div className="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><AlertTriangle className="w-8 h-8 text-red-600" /></div><h2 className="text-xl font-bold text-gray-800 mb-2">ç¢ºå®šåˆªé™¤å—ï¼Ÿ</h2><p className="text-gray-500 text-sm mb-6">é€™ç­†æ­·å²ç´€éŒ„å°‡æœƒæ°¸ä¹…åˆªé™¤ï¼Œç„¡æ³•å¾©åŸã€‚</p><div className="flex gap-3"><button onClick={() => setIsDeleteConfirmOpen(false)} className="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">å–æ¶ˆ</button><button onClick={executeDeleteHistory} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg flex items-center justify-center gap-2">{isSyncing ? <RefreshCw className="w-5 h-5 animate-spin" /> : "ç¢ºèªåˆªé™¤"}</button></div></div></div>)}
                    
                    {toast.show && (<div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-slide-up z-50 whitespace-nowrap">{toast.type === 'success' ? <CheckCircle className="w-5 h-5 text-green-400" /> : <AlertTriangle className="w-5 h-5 text-yellow-400" />}<span className="font-medium text-sm">{toast.message}</span></div>)}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
