<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‰ø°Áî®Âç°ÁÆ°ÂÆ∂</title>

    <!-- PWA Ë®≠ÂÆö -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22 rx=%2220%22></rect><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>üí≥</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22></rect><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>üí≥</text></svg>">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href='data:application/manifest+json,{"name":"‰ø°Áî®Âç°ÁÆ°ÂÆ∂","short_name":"Âà∑Âç°ÁÆ°ÂÆ∂","start_url":".","display":"standalone","background_color":"#f9fafb","theme_color":"#ffffff","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/633/633611.png","sizes":"192x192","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* Mobile Optimizations */
        body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom); 
            background-color: #f9fafb;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile browser */
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
        
        .nav-active { color: #2563eb; font-weight: 600; }
        .card-shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; filter: brightness(0.95); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scroll-touch { -webkit-overflow-scrolling: touch; }
        
        /* Prevent iOS Zoom on Input Focus (Font size >= 16px) */
        input, select, textarea { font-size: 16px !important; }

        /* Toast Animation */
        @keyframes slide-up { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, -20px); opacity: 1; } }
        .toast-enter { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Modal Animation - Bottom Sheet Style */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up-modal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-overlay { animation: fade-in 0.2s ease-out forwards; }
        .modal-content { animation: slide-up-modal 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="text-gray-900 font-sans h-full select-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Trash2, Edit2, RotateCcw, CreditCard, DollarSign, TrendingUp, AlertCircle, X, History, Calendar, Key, LogIn, LogOut, CheckCircle, Save, AlertTriangle, ChevronDown, ChevronUp, ChevronRight, FileCheck, CalendarClock, Globe, ExternalLink, Settings, Wallet, Download, Landmark, Upload, PenLine, Tag, Filter, RefreshCw, MoreHorizontal } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, deleteDoc, updateDoc, getDoc, onSnapshot, collection, query, orderBy, writeBatch } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyDraphMDkK-uXpC-PMRM75p9h_e6VYSXEQ",
            authDomain: "cards-reward.firebaseapp.com",
            projectId: "cards-reward",
            storageBucket: "cards-reward.firebasestorage.app",
            messagingSenderId: "450336524248",
            appId: "1:450336524248:web:ecf5b879698b590e6414ad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const COLORS = [
            { name: "Á¥ÖËâ≤", value: "bg-red-500" }, { name: "ËóçËâ≤", value: "bg-blue-500" }, { name: "Á∂†Ëâ≤", value: "bg-green-500" },
            { name: "Á¥´Ëâ≤", value: "bg-purple-500" }, { name: "Ê©òËâ≤", value: "bg-orange-500" }, { name: "ÈªëËâ≤", value: "bg-gray-800" }, { name: "ÈùíËâ≤", value: "bg-teal-600" }
        ];

        // --- Toast Component ---
        const Toast = ({ message, type }) => (
            <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-2xl shadow-xl text-white text-sm font-bold z-[60] flex items-center gap-3 toast-enter backdrop-blur-md ${type === 'error' ? 'bg-red-500/90' : 'bg-gray-800/90'}`}>
                {type === 'error' ? <AlertCircle className="w-5 h-5"/> : <CheckCircle className="w-5 h-5"/>}
                {message}
            </div>
        );

        function App() {
            // --- Core State ---
            const [user, setUser] = useState(null);
            const [syncId, setSyncId] = useState(() => localStorage.getItem('card_manager_sync_id') || '');
            const [inputSyncId, setInputSyncId] = useState('');
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);

            // --- Data State ---
            const [cards, setCards] = useState([]);
            const [banks, setBanks] = useState([]);
            const [history, setHistory] = useState([]);
            
            // --- UI Toggle State ---
            const [isScheduleExpanded, setIsScheduleExpanded] = useState(false);
            const [isBanksExpanded, setIsBanksExpanded] = useState(false); // New: Toggle banks
            const [collapsedBanks, setCollapsedBanks] = useState({});
            const [collapsedYears, setCollapsedYears] = useState({});
            const [expandedCardId, setExpandedCardId] = useState(null);
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            const [selectedTag, setSelectedTag] = useState(null);
            const [expandedScheduleId, setExpandedScheduleId] = useState(null);

            // --- Modal State ---
            const [modal, setModal] = useState({ type: null, data: null }); // type: 'spend', 'editCard', 'settle', 'editBank'
            
            // --- Form State ---
            const [formData, setFormData] = useState({});
            const [tagInput, setTagInput] = useState("");
            const [spendAmount, setSpendAmount] = useState("");
            const [isSubtractMode, setIsSubtractMode] = useState(false);
            
            // --- Refs ---
            const hasCheckedAuto = useRef(false);
            const fileInputRef = useRef(null);

            // --- Effects ---
            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !syncId) { setLoading(false); return; }
                setLoading(true);

                const unsubBanks = onSnapshot(doc(db, 'users', syncId, 'data', 'banks_v1'), (snap) => {
                    setBanks(snap.exists() ? snap.data().list || [] : []);
                });

                const unsubCards = onSnapshot(doc(db, 'users', syncId, 'data', 'cards_v2'), (snap) => {
                    if (snap.exists()) {
                        const list = snap.data().list || [];
                        setCards(list);
                        if (!hasCheckedAuto.current && list.length > 0) {
                            hasCheckedAuto.current = true;
                            setTimeout(() => runAutoReset(list), 500);
                        }
                    } else {
                         setDoc(doc(db, 'users', syncId, 'data', 'cards_v2'), { list: [] });
                         setCards([]);
                    }
                    setLoading(false);
                });

                const q = query(collection(db, 'users', syncId, 'history'), orderBy('monthStr', 'desc'));
                const unsubHistory = onSnapshot(q, (snap) => {
                    setHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubBanks(); unsubCards(); unsubHistory(); };
            }, [user, syncId]);

            // --- Helper Functions ---
            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const copySyncId = () => {
                const ta = document.createElement("textarea"); ta.value = syncId; document.body.appendChild(ta); ta.select();
                try { document.execCommand('copy'); showToast('Â∑≤Ë§áË£Ω‰ª£Á¢º'); } catch { showToast('Ë§áË£ΩÂ§±Êïó', 'error'); }
                document.body.removeChild(ta);
            };

            const saveData = async (path, data) => {
                try { await setDoc(doc(db, 'users', syncId, 'data', path), data, { merge: true }); return true; } 
                catch (e) { showToast("ÂÑ≤Â≠òÂ§±Êïó", "error"); return false; }
            };

            const calcReward = (card) => {
                let total = 0; const spend = parseFloat(card.currentSpend)||0; const breakdown = [];
                (card.rewards||[]).forEach(r => {
                    const amt = Math.floor(Math.min(spend, (parseFloat(r.cap)||99999999)) * (parseFloat(r.rate)/100));
                    total += amt; breakdown.push({...r, amount: amt});
                });
                return { total, breakdown };
            };

            const getTotalSpend = (cardList) => cardList.reduce((sum, c) => sum + (c.currentSpend || 0), 0);
            const getTotalReward = (cardList) => cardList.reduce((sum, c) => sum + calcReward(c).total, 0);

            const getBillingInfo = (day) => {
                if(!day) return null;
                const today = new Date();
                let diff = day - today.getDate();
                if(diff < 0) diff += 30; // approx
                return diff;
            };

            const getNextDate = (day) => {
                if(!day) return null;
                const today = new Date(); today.setHours(0,0,0,0);
                let target = new Date(today.getFullYear(), today.getMonth(), day);
                while(target.getMonth() !== today.getMonth()) target.setDate(target.getDate()-1);
                if(target < today) {
                    target = new Date(today.getFullYear(), today.getMonth()+1, day);
                    while(target.getMonth() !== (today.getMonth()+1)%12) target.setDate(target.getDate()-1);
                }
                return target;
            };

            // --- Logic Actions ---
            const handleLogin = (e) => {
                e.preventDefault();
                if(!inputSyncId.trim()) return showToast("Ë´ãËº∏ÂÖ•ÂØÜÁ¢º", "error");
                setSyncId(inputSyncId.trim()); localStorage.setItem('card_manager_sync_id', inputSyncId.trim());
            };

            const handleLogout = () => {
                if(confirm("Á¢∫ÂÆöÁôªÂá∫?")) { setSyncId(''); localStorage.removeItem('card_manager_sync_id'); setCards([]); setBanks([]); setHistory([]); }
            };

            const saveCard = async () => {
                if(!formData.name) return showToast("ÂêçÁ®±‰∏çÂèØÁÇ∫Á©∫", "error");
                const tags = tagInput.split(/[,Ôºå\s]+/).filter(t => t.trim().length > 0);
                const dataToSave = { ...formData, tags };
                
                const newCards = modal.data 
                    ? cards.map(c => c.id === modal.data.id ? { ...dataToSave, id: c.id } : c)
                    : [...cards, { ...dataToSave, id: Date.now() }];
                if(await saveData('cards_v2', { list: newCards })) { setModal({ type: null }); showToast("Â∑≤ÂÑ≤Â≠ò"); }
            };

             const saveBank = async () => {
                if(!formData.name) return showToast("ÈäÄË°åÂêçÁ®±‰∏çÂèØÁÇ∫Á©∫", "error");
                const newBanks = modal.data
                    ? banks.map(b => b.id === modal.data.id ? { ...formData, id: b.id } : b)
                    : [...banks, { ...formData, id: 'b_'+Date.now() }];
                if(await saveData('banks_v1', { list: newBanks })) { setModal({ type: null }); showToast("ÈäÄË°åË®≠ÂÆöÂ∑≤Êõ¥Êñ∞"); }
            };

            const deleteCard = async (id) => {
                if(confirm("Âà™Èô§Ê≠§Âç°Áâá?")) {
                    const newCards = cards.filter(c => c.id !== id);
                    if(await saveData('cards_v2', { list: newCards })) { setModal({ type: null }); showToast("Â∑≤Âà™Èô§"); }
                }
            };
            
            const deleteBank = async (id) => {
                if(confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§ÈäÄË°åË®≠ÂÆö? (ÈóúËÅØÂç°ÁâáÂèØËÉΩÈúÄÈáçÊñ∞Ë®≠ÂÆö)")) {
                    const newBanks = banks.filter(b => b.id !== id);
                    if(await saveData('banks_v1', { list: newBanks })) { setModal({ type: null }); showToast("Â∑≤Âà™Èô§ÈäÄË°å"); }
                }
            };

            const addSpend = async () => {
                const val = parseFloat(spendAmount);
                if(isNaN(val)) return;
                const amt = isSubtractMode ? -val : val;
                const newCards = cards.map(c => c.id === modal.data.id ? { ...c, currentSpend: Math.max(0, (c.currentSpend||0) + amt) } : c);
                if(await saveData('cards_v2', { list: newCards })) { setModal({ type: null }); showToast(isSubtractMode ? "Â∑≤Êâ£Èô§" : "Ë®òÂ∏≥ÊàêÂäü"); }
            };

            const settleCards = async () => {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const target = modal.data;
                const type = modal.settleType;

                let targets = [];
                if (target) {
                    targets = [target];
                } else if (type === 'month') {
                    targets = cards.filter(c => c.currentSpend > 0 && (c.cycleType === 'month' || !c.cycleType));
                } else {
                    return;
                }
                
                if(targets.length === 0) { setModal({ type: null }); return showToast("ÁÑ°È†àÁµêÁÆó"); }

                try {
                    const histRef = doc(db, 'users', syncId, 'history', currentMonth);
                    const snap = await getDoc(histRef);
                    let histData = snap.exists() ? snap.data() : { totalSpend: 0, totalReward: 0, cardsSnapshot: [] };
                    
                    let newSnapshot = [...(histData.cardsSnapshot || [])];
                    
                    targets.forEach(c => {
                        const r = calcReward(c);
                        histData.totalSpend += c.currentSpend;
                        histData.totalReward += r.total;
                        
                        const idx = newSnapshot.findIndex(s => s.name === c.name);
                        if(idx >= 0) {
                            newSnapshot[idx].spend += c.currentSpend;
                            newSnapshot[idx].reward += r.total;
                        } else {
                            newSnapshot.push({ name: c.name, color: c.color, spend: c.currentSpend, reward: r.total });
                        }
                    });

                    await setDoc(histRef, { ...histData, cardsSnapshot: newSnapshot, monthStr: currentMonth, timestamp: new Date().toISOString() });
                    
                    const newCards = cards.map(c => {
                        const isTarget = targets.find(t => t.id === c.id);
                        if (isTarget) {
                            return { ...c, currentSpend: 0, lastSettled: currentMonth };
                        }
                        return c;
                    });
                    
                    await saveData('cards_v2', { list: newCards });
                    setModal({ type: null });
                    showToast(target ? "ÂñÆÂç°Â∑≤ÁµêÁÆó" : "ÊúàÂà∂Âç°ÁâáÂ∑≤ÂÖ®Áµê");
                } catch(e) { console.error(e); showToast("ÁµêÁÆóÂ§±Êïó", "error"); }
            };

            const runAutoReset = async (currentCards, isManual = false) => {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const today = new Date().getDate();
                let needsUpdate = false;
                let resetNames = [];
                
                let currentBanks = banks;
                if(currentBanks.length === 0 && !isManual) {
                     try {
                        const bSnap = await getDoc(doc(db, 'users', syncId, 'data', 'banks_v1'));
                        if(bSnap.exists()) currentBanks = bSnap.data().list || [];
                    } catch {}
                }

                let histData = { totalSpend: 0, totalReward: 0, cardsSnapshot: [] };
                let histRef = doc(db, 'users', syncId, 'history', currentMonth);
                
                const cardsToReset = [];

                const newCards = currentCards.map(c => {
                    const last = c.lastSettled || currentMonth;
                    let shouldReset = false;
                    
                    let bDay = c.billingDay;
                    if(c.bankId) {
                        const b = currentBanks.find(k => k.id === c.bankId);
                        if(b) bDay = b.billingDay;
                    }

                    if(c.currentSpend > 0) {
                        if(c.cycleType === 'billing') {
                            if(currentMonth !== last && today >= (bDay || 1)) shouldReset = true;
                        } else {
                            if(currentMonth !== last) shouldReset = true;
                        }
                    } else {
                         if(c.cycleType === 'billing') {
                            if(currentMonth !== last && today >= (bDay || 1)) return { ...c, lastSettled: currentMonth };
                        } else {
                            if(currentMonth !== last) return { ...c, lastSettled: currentMonth };
                        }
                    }

                    if(shouldReset) {
                        cardsToReset.push(c);
                        return { ...c, currentSpend: 0, lastSettled: currentMonth };
                    }
                    return c;
                });

                if(cardsToReset.length > 0) {
                    try {
                        const snap = await getDoc(histRef);
                        if(snap.exists()) histData = snap.data();
                        
                        let newSnapshot = [...(histData.cardsSnapshot || [])];

                        cardsToReset.forEach(c => {
                            const r = calcReward(c);
                            histData.totalSpend += c.currentSpend;
                            histData.totalReward += r.total;
                            resetNames.push(c.name);

                            const idx = newSnapshot.findIndex(s => s.name === c.name);
                            if(idx >= 0) {
                                newSnapshot[idx].spend += c.currentSpend;
                                newSnapshot[idx].reward += r.total;
                            } else {
                                newSnapshot.push({ name: c.name, color: c.color, spend: c.currentSpend, reward: r.total });
                            }
                        });

                        await setDoc(histRef, { ...histData, cardsSnapshot: newSnapshot, monthStr: currentMonth, timestamp: new Date().toISOString() });
                        await saveData('cards_v2', { list: newCards });
                        setCards(newCards);
                        showToast(isManual ? `Â∑≤ÁµêÁÆó: ${resetNames.join(', ')}` : `Ëá™ÂãïÁµêÁÆó: ${resetNames.join(', ')}`);
                    } catch(e) { console.error(e); if(isManual) showToast("ÁµêÁÆóÂ§±Êïó", "error"); }
                } else {
                    if(isManual) showToast("ÁõÆÂâçÊ≤íÊúâÁ¨¶ÂêàÈÄ±ÊúüÁöÑÂç°ÁâáÈúÄÁµêÁÆó");
                }
            };

            // --- Layout Rendering Helpers ---
            const content = () => {
                // 1. DASHBOARD
                if (syncId && view === 'dashboard') {
                    const filteredCards = selectedTag 
                        ? cards.filter(c => (c.tags || []).includes(selectedTag))
                        : cards;

                    const totalSpend = getTotalSpend(cards); 
                    const totalReward = getTotalReward(cards);
                    
                    const groups = [];
                    banks.forEach(b => {
                        const sub = filteredCards.filter(c => c.bankId === b.id);
                        if(sub.length > 0) groups.push({ ...b, cards: sub });
                    });
                    const others = filteredCards.filter(c => !c.bankId || !banks.find(b => b.id === c.bankId));
                    if(others.length > 0) groups.push({ id: 'other', name: 'Êú™ÂàÜÈ°û', cards: others });

                    const schedule = [];
                    banks.forEach(b => {
                        const bankCards = cards.filter(c => c.bankId === b.id);
                        if(bankCards.length > 0) {
                            const nextBill = getNextDate(b.billingDay);
                            const nextPay = getNextDate(b.paymentDay);
                            const today = new Date(); today.setHours(0,0,0,0);
                            
                            if(nextBill) {
                                schedule.push({ 
                                    id: b.id+'_bill', name: b.name, type: 'ÁµêÂ∏≥', 
                                    date: nextBill, days: Math.ceil((nextBill-today)/86400000), 
                                    color: 'bg-gray-800', isGroup: true, cards: bankCards 
                                });
                            }
                            if(nextPay) {
                                schedule.push({ 
                                    id: b.id+'_pay', name: b.name, type: 'Áπ≥Ê¨æ', 
                                    date: nextPay, days: Math.ceil((nextPay-today)/86400000), 
                                    color: 'bg-gray-800', isGroup: true, cards: bankCards 
                                });
                            }
                        }
                    });

                    cards.filter(c => !c.bankId).forEach(c => {
                         const nextBill = getNextDate(c.billingDay);
                         const nextPay = getNextDate(c.paymentDay);
                         const today = new Date(); today.setHours(0,0,0,0);
                         if(nextBill) schedule.push({ id: c.id+'b', name: c.name, type: 'ÁµêÂ∏≥', date: nextBill, days: Math.ceil((nextBill-today)/86400000), color: c.color, isGroup: false });
                         if(nextPay) schedule.push({ id: c.id+'p', name: c.name, type: 'Áπ≥Ê¨æ', date: nextPay, days: Math.ceil((nextPay-today)/86400000), color: c.color, isGroup: false });
                    });
                    schedule.sort((a,b) => a.days - b.days);

                    const allTags = Array.from(new Set(cards.flatMap(c => c.tags || [])));

                    return (
                        <div className="px-4 pt-4 pb-24">
                            {/* Mobile Header - Compact */}
                            <div className="bg-white rounded-2xl shadow-sm p-4 mb-4 border border-gray-100">
                                <div className="flex justify-between items-center mb-3">
                                    <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Wallet className="text-blue-600 w-5 h-5"/> ‰ø°Áî®Âç°ÁÆ°ÂÆ∂</h1>
                                    <button onClick={() => setModal({ type: 'settle', settleType: 'month' })} className="btn-press px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold flex items-center gap-1"><FileCheck className="w-3 h-3"/> ÊúàÁµêÁÆó</button>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="p-3 bg-gray-50 rounded-xl">
                                        <div className="text-xs text-gray-500 mb-0.5">Êú¨ÊúàÁ∏ΩÂà∑</div>
                                        <div className="text-lg font-bold text-blue-900">${totalSpend.toLocaleString()}</div>
                                    </div>
                                    <div className="p-3 bg-green-50 rounded-xl">
                                        <div className="text-xs text-green-600 mb-0.5">È†ê‰º∞ÂõûÈ•ã</div>
                                        <div className="text-lg font-bold text-green-700">+${totalReward.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Tags Filter - Horizontal Scroll with Touch */}
                            {allTags.length > 0 && (
                                <div className="mb-4 overflow-x-auto whitespace-nowrap scroll-touch flex gap-2 pb-1 no-scrollbar">
                                    <button onClick={() => setSelectedTag(null)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition btn-press ${!selectedTag ? 'bg-gray-800 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200'}`}>ÂÖ®ÈÉ®</button>
                                    {allTags.map(tag => (
                                        <button key={tag} onClick={() => setSelectedTag(tag === selectedTag ? null : tag)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-1 btn-press ${tag === selectedTag ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200'}`}>
                                            <Tag className="w-3 h-3"/> {tag}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {/* Schedule Widget */}
                            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
                                <div className="flex justify-between items-center mb-3 cursor-pointer py-1" onClick={() => setIsScheduleExpanded(!isScheduleExpanded)}>
                                    <h2 className="font-bold text-gray-700 flex gap-2 text-sm"><CalendarClock className="w-4 h-4 text-purple-500"/> ËøëÊúüÁπ≥Ë≤ª</h2>
                                    {isScheduleExpanded ? <ChevronUp className="text-gray-400 w-5 h-5"/> : <ChevronDown className="text-gray-400 w-5 h-5"/>}
                                </div>
                                <div className="space-y-3">
                                    {schedule.length === 0 ? <p className="text-gray-400 text-xs text-center py-2">ÁÑ°ÂæÖËæ¶‰∫ãÈ†Ö</p> : 
                                    (isScheduleExpanded ? schedule : schedule.slice(0, 1)).map(item => (
                                        <div key={item.id} className="bg-gray-50 rounded-xl p-3 btn-press">
                                            <div className="flex justify-between items-center text-sm cursor-pointer" onClick={() => item.isGroup && setExpandedScheduleId(expandedScheduleId === item.id ? null : item.id)}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-1 h-8 rounded-full ${item.color}`}></div>
                                                    <div>
                                                        <div className="font-bold text-gray-700 flex items-center gap-2">
                                                            {item.name}
                                                            {item.isGroup && <span className="bg-gray-200 text-gray-600 text-[10px] px-1.5 rounded-full">{item.cards.length}Âºµ</span>}
                                                        </div>
                                                        <div className="text-xs text-gray-400 mt-0.5">{item.date.getMonth()+1}/{item.date.getDate()} {item.type}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-bold ${item.days<=3?'text-red-500':'text-gray-600'}`}>{item.days} Â§©Âæå</span>
                                                    {item.isGroup && (expandedScheduleId === item.id ? <ChevronUp className="w-4 h-4 text-gray-400"/> : <ChevronDown className="w-4 h-4 text-gray-400"/>)}
                                                </div>
                                            </div>
                                            {/* Sub-items for Groups */}
                                            {item.isGroup && expandedScheduleId === item.id && (
                                                <div className="mt-3 pt-2 border-t border-gray-200 space-y-3">
                                                    {item.cards.map(sub => (
                                                        <div key={sub.id} className="flex justify-between items-center text-xs pl-4">
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-1.5 h-1.5 rounded-full ${sub.color}`}></div>
                                                                <span className="text-gray-600">{sub.name}</span>
                                                            </div>
                                                            <span className="text-gray-500 font-mono">${sub.currentSpend.toLocaleString()}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    {!isScheduleExpanded && schedule.length > 1 && <div className="text-center text-xs text-blue-500 pt-1 font-bold">ÈÇÑÊúâ {schedule.length - 1} Á≠Ü...</div>}
                                </div>
                            </div>

                            {/* Cards List */}
                            <div className="space-y-4">
                                {groups.map(g => (
                                    <div key={g.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div className="flex items-center justify-between p-4 cursor-pointer select-none bg-gray-50/50 active:bg-gray-100 transition" onClick={() => setCollapsedBanks({...collapsedBanks, [g.id]: !collapsedBanks[g.id]})}>
                                            <div className="flex items-center gap-2">
                                                <div className={`transition-transform duration-200 ${collapsedBanks[g.id]?'':'rotate-90'}`}><ChevronRight className="w-5 h-5 text-gray-400"/></div>
                                                <h3 className="font-bold text-gray-700 text-lg">{g.name}</h3>
                                            </div>
                                            <span className="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full font-bold">{g.cards.length}</span>
                                        </div>
                                        {!collapsedBanks[g.id] && (
                                            <div className="p-3 space-y-3">
                                                {g.cards.map(c => {
                                                    const r = calcReward(c);
                                                    const caps = (c.rewards||[]).map(x=>parseFloat(x.cap)).filter(x=>x>0).sort((a,b)=>a-b);
                                                    const maxCap = caps.length > 0 ? caps[caps.length-1] : 0;
                                                    const progress = maxCap > 0 ? Math.min((c.currentSpend / maxCap) * 100, 100) : 0;
                                                    const isOver = maxCap > 0 && c.currentSpend >= maxCap;

                                                    let bDay = c.billingDay;
                                                    if(c.bankId) { const b = banks.find(k => k.id === c.bankId); if(b) bDay = b.billingDay; }
                                                    const daysLeft = getBillingInfo(bDay);

                                                    return (
                                                        <div key={c.id} className="bg-white rounded-2xl border border-gray-100 relative overflow-hidden card-shadow btn-press transition-transform" onClick={() => { setSpendAmount(""); setIsSubtractMode(false); setModal({ type: 'spend', data: c }); }}>
                                                            <div className={`absolute left-0 top-0 bottom-0 w-2 ${c.color}`}></div>
                                                            <div className="p-4 pl-6">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <div className="font-bold text-lg text-gray-800 flex items-center gap-2">
                                                                            {c.name}
                                                                            {isOver && <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">Â∑≤Êªø</span>}
                                                                            {c.officialUrl && <a href={c.officialUrl} target="_blank" onClick={e=>e.stopPropagation()}><Globe className="w-4 h-4 text-gray-400"/></a>}
                                                                        </div>
                                                                        {(c.tags && c.tags.length > 0) && (
                                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                                {c.tags.map((t, idx) => (
                                                                                    <span key={idx} className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{t}</span>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                        <div className="text-xs text-gray-400 mt-2 flex flex-wrap gap-2">
                                                                            <span className="bg-gray-100 px-1.5 py-0.5 rounded">{c.cycleType==='billing'?'ÈÄ±Êúü':'ÊúàÂà∂'}</span>
                                                                            <span>{maxCap>0?`‰∏äÈôê $${maxCap.toLocaleString()}`:'ÁÑ°‰∏äÈôê'}</span>
                                                                            {bDay && <span className={daysLeft<=3?'text-orange-500 font-bold':''}>{bDay}Êó•Áµê (Ââ©{daysLeft}Â§©)</span>}
                                                                        </div>
                                                                    </div>
                                                                    <button onClick={(e) => { e.stopPropagation(); setFormData(c); setTagInput((c.tags||[]).join(', ')); setModal({ type: 'editCard', data: c }); }} className="p-3 bg-gray-50 rounded-full active:bg-gray-200 transition"><Edit2 className="w-5 h-5 text-gray-500"/></button>
                                                                </div>
                                                                <div className="flex justify-between items-end mb-3 mt-4">
                                                                    <div className="text-3xl font-bold text-gray-900 tracking-tight font-mono">${c.currentSpend.toLocaleString()}</div>
                                                                    <div className="text-green-600 font-bold text-sm">+${r.total.toLocaleString()}</div>
                                                                </div>
                                                                <div className="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-3">
                                                                    <div className={`h-full ${c.color}`} style={{ width: `${progress}%` }}></div>
                                                                </div>
                                                                <div className="flex justify-end pt-2 border-t border-gray-50">
                                                                    <button onClick={(e) => { e.stopPropagation(); setModal({ type: 'settle', data: c }); }} className="text-xs flex items-center gap-1 text-gray-500 px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 font-bold"><FileCheck className="w-3 h-3"/> ÁµêÁÆóÊ≠§Âç°</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {groups.length===0 && (
                                    selectedTag ? 
                                    <div className="text-center py-10 text-gray-400">Êâæ‰∏çÂà∞Ê®ôÁ±§ÁÇ∫„Äå{selectedTag}„ÄçÁöÑÂç°Áâá</div> :
                                    <div className="text-center py-10 text-gray-400">ÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢ûÂç°Áâá</div>
                                )}
                            </div>
                            
                            {/* Mobile Inline Add Button (Large Touch Target) */}
                            <div className="px-2 pt-6 pb-8">
                                <button onClick={() => { setFormData({ name:'', color: COLORS[0].value, rewards: [{name:'‰∏ÄËà¨',rate:1,cap:0}], currentSpend:0, tags:[], cycleType:'month' }); setTagInput(""); setModal({ type: 'editCard', data: null }); }} className="w-full py-5 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 flex items-center justify-center gap-2 active:bg-gray-50 active:border-blue-400 active:text-blue-500 transition font-bold text-lg">
                                    <Plus className="w-6 h-6" /> Êñ∞Â¢ûÂç°Áâá
                                </button>
                            </div>
                            
                            {/* FAB - Lifted for safe area */}
                            <button onClick={() => { setFormData({ name:'', color: COLORS[0].value, rewards: [{name:'‰∏ÄËà¨',rate:1,cap:0}], currentSpend:0, tags:[], cycleType:'month' }); setTagInput(""); setModal({ type: 'editCard', data: null }); }} className="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-blue-700 btn-press z-30"><Plus className="w-8 h-8" /></button>
                        </div>
                    );
                }

                // 2. HISTORY
                if (syncId && view === 'history') {
                    const historyByYear = history.reduce((acc, item) => {
                        const year = item.monthStr.split('-')[0];
                        if (!acc[year]) acc[year] = { year, items: [], totalSpend: 0, totalReward: 0 };
                        acc[year].items.push(item);
                        acc[year].totalSpend += (item.totalSpend || 0);
                        acc[year].totalReward += (item.totalReward || 0);
                        return acc;
                    }, {});

                    const sortedYears = Object.values(historyByYear).sort((a, b) => b.year - a.year);

                    return (
                        <div className="px-4 pt-6 pb-24">
                            <h1 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><History className="w-7 h-7"/> Ê≠∑Âè≤Á¥ÄÈåÑ</h1>
                            <div className="space-y-4">
                                {sortedYears.map(group => (
                                    <div key={group.year} className="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div className="bg-gray-50 p-4 flex justify-between items-center cursor-pointer select-none active:bg-gray-100" onClick={() => setCollapsedYears({...collapsedYears, [group.year]: !collapsedYears[group.year]})}>
                                            <div className="flex items-center gap-2">
                                                <div className={`transition-transform duration-200 ${!collapsedYears[group.year] ? 'rotate-90' : ''}`}><ChevronRight className="w-5 h-5 text-gray-400"/></div>
                                                <span className="font-bold text-lg text-gray-800">{group.year}Âπ¥</span>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-gray-900 text-lg">${group.totalSpend.toLocaleString()}</div>
                                                <div className="text-xs text-green-600">+${group.totalReward.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        
                                        {!collapsedYears[group.year] && (
                                            <div className="p-2 space-y-2">
                                                {group.items.map(h => (
                                                    <div key={h.id} className="bg-white rounded-xl border border-gray-100 p-4">
                                                        <div className="flex justify-between items-center mb-1 cursor-pointer min-h-[44px]" onClick={() => setExpandedHistoryId(expandedHistoryId === h.id ? null : h.id)}>
                                                            <div className="font-bold text-gray-700 flex items-center gap-2">
                                                                <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-sm">{h.monthStr.split('-')[1]}Êúà</span>
                                                            </div>
                                                            <div className="text-right flex items-center gap-3">
                                                                <div>
                                                                    <span className="font-bold text-gray-800 text-lg">${h.totalSpend?.toLocaleString()}</span>
                                                                    <span className="text-green-600 text-xs ml-1 block">+${h.totalReward?.toLocaleString()}</span>
                                                                </div>
                                                                {expandedHistoryId === h.id ? <ChevronUp className="w-5 h-5 text-gray-400"/> : <ChevronDown className="w-5 h-5 text-gray-400"/>}
                                                            </div>
                                                        </div>
                                                        {expandedHistoryId === h.id && (
                                                            <div className="mt-3 pt-3 border-t border-gray-100 space-y-3">
                                                                {(h.cardsSnapshot||[]).map((c, i) => (
                                                                    <div key={i} className="flex justify-between text-sm text-gray-600 pl-2 border-l-2 border-gray-100">
                                                                        <div className="flex items-center gap-2 text-base">{c.name}</div>
                                                                        <div className="text-base">${c.spend?.toLocaleString()} <span className="text-green-600 text-xs">(+${c.reward})</span></div>
                                                                    </div>
                                                                ))}
                                                                <button onClick={async () => { if(confirm("Âà™Èô§?")) { await deleteDoc(doc(db, 'users', syncId, 'history', h.id)); showToast("Â∑≤Âà™Èô§"); } }} className="w-full py-3 mt-2 bg-red-50 text-red-600 rounded-xl text-sm font-bold active:bg-red-100">Âà™Èô§Ê≠§ÊúàÁ¥ÄÈåÑ</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {sortedYears.length===0 && <div className="text-center py-10 text-gray-400">Â∞öÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ</div>}
                            </div>
                        </div>
                    );
                }

                // 3. SETTINGS
                if (syncId && view === 'settings') {
                    return (
                        <div className="px-4 pt-6 pb-24">
                            <h1 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Settings className="w-7 h-7"/> Ë®≠ÂÆö</h1>
                            
                            <div className="bg-white rounded-2xl p-5 shadow-sm mb-6">
                                <div className="text-sm text-gray-500 mb-2">ÈÄ£ÂãïÂØÜÁ¢º (Sync ID)</div>
                                <div className="flex justify-between items-center bg-gray-100 p-4 rounded-xl font-mono text-xl font-bold text-gray-700 select-all">
                                    {syncId}
                                    <button onClick={copySyncId} className="text-blue-600 text-sm font-sans font-bold px-3 py-1 bg-white rounded-lg shadow-sm">Ë§áË£Ω</button>
                                </div>
                            </div>

                             {/* SETTLEMENT CENTER */}
                            <div className="bg-white rounded-2xl p-5 shadow-sm mb-6">
                                <div className="font-bold text-gray-800 mb-4 flex items-center gap-2"><FileCheck className="w-5 h-5"/> ÁµêÁÆó‰∏≠ÂøÉ</div>
                                <div className="space-y-3">
                                    <div className="bg-gray-50 p-4 rounded-xl flex items-center justify-between" onClick={() => setModal({ type: 'settle', settleType: 'month' })}>
                                        <div>
                                            <div className="font-bold text-gray-700 text-base">ÊúàÂà∂Âç°ÁâáÁµêÁÆó</div>
                                            <div className="text-xs text-gray-400 mt-1">ÈáùÂ∞ç„ÄåÊØèÊúà1ËôüÈáçÁΩÆ„ÄçÁöÑÂç°Áâá</div>
                                        </div>
                                        <button className="px-4 py-2 bg-white border border-gray-200 shadow-sm rounded-lg text-sm font-bold text-blue-600">‰∏ÄÈçµÁµêÁÆó</button>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-xl flex items-center justify-between" onClick={() => runAutoReset(cards, true)}>
                                        <div>
                                            <div className="font-bold text-gray-700 text-base">Ê™¢Êü•ÈÄ±ÊúüÂç°Áâá</div>
                                            <div className="text-xs text-gray-400 mt-1">ÊâãÂãïÊ™¢Êü•„ÄåÂ∏≥ÂñÆÊó•„ÄçÂ∑≤ÈÅéÁöÑÂç°Áâá</div>
                                        </div>
                                        <button className="px-4 py-2 bg-white border border-gray-200 shadow-sm rounded-lg text-sm font-bold text-purple-600 flex items-center gap-1"><RefreshCw className="w-3 h-3"/> Ê™¢Êü•</button>
                                    </div>
                                </div>
                            </div>

                            {/* BANK MANAGEMENT - COLLAPSIBLE */}
                            <div className="bg-white rounded-2xl overflow-hidden shadow-sm mb-6">
                                <div 
                                    className="p-5 flex justify-between items-center active:bg-gray-50 transition cursor-pointer"
                                    onClick={() => setIsBanksExpanded(!isBanksExpanded)}
                                >
                                    <div className="font-bold text-gray-800 flex items-center gap-2">
                                        <Landmark className="w-5 h-5"/> ÈäÄË°åÁÆ°ÁêÜ
                                        {!isBanksExpanded && <span className="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full font-normal">Â∑≤Ë®≠ÂÆö {banks.length} ÂÆ∂</span>}
                                    </div>
                                    {isBanksExpanded ? <ChevronUp className="text-gray-400 w-5 h-5"/> : <ChevronDown className="text-gray-400 w-5 h-5"/>}
                                </div>
                                
                                {isBanksExpanded && (
                                    <div className="p-5 pt-0 border-t border-gray-50 animate-fade-in">
                                        <div className="space-y-3 mb-4 mt-4">
                                            {banks.map(b => (
                                                <div key={b.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl active:bg-gray-100 transition" onClick={() => { setFormData(b); setModal({ type: 'editBank', data: b }); }}>
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 font-bold">{b.name.charAt(0)}</div>
                                                        <div>
                                                            <div className="font-bold text-gray-800 text-base">{b.name}</div>
                                                            <div className="text-xs text-gray-500">ÁµêÂ∏≥Êó• {b.billingDay} / Áπ≥Ê¨æÊó• {b.paymentDay}</div>
                                                        </div>
                                                    </div>
                                                    <Edit2 className="w-5 h-5 text-gray-400"/>
                                                </div>
                                            ))}
                                            {banks.length === 0 && <div className="text-center text-gray-400 text-sm py-2">Â∞öÊú™Ë®≠ÂÆöÈäÄË°å</div>}
                                        </div>
                                        <button onClick={() => { setFormData({name:'', billingDay:'', paymentDay:''}); setModal({ type: 'editBank', data: null }); }} className="w-full py-4 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2 active:bg-blue-100"><Plus className="w-5 h-5"/> Êñ∞Â¢ûÈäÄË°å</button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="bg-white rounded-2xl p-4 shadow-sm mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="font-bold">Ë≥áÊñôÂÇô‰ªΩ</div>
                                    <div className="flex gap-2">
                                        <button onClick={() => {
                                            const blob = new Blob([JSON.stringify({ syncId, timestamp: new Date().toISOString(), cards, banks, history }, null, 2)], {type: "application/json"});
                                            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                                        }} className="bg-gray-100 px-4 py-2 rounded-lg text-sm font-bold flex gap-1 active:bg-gray-200"><Download className="w-4 h-4"/> ‰∏ãËºâ</button>
                                        <input type="file" ref={fileInputRef} style={{display:'none'}} onChange={async (e) => {
                                            const file = e.target.files[0]; if(!file) return;
                                            const reader = new FileReader();
                                            reader.onload = async (ev) => {
                                                try {
                                                    const data = JSON.parse(ev.target.result);
                                                    if(confirm("Á¢∫ÂÆöÈÇÑÂéü?")) {
                                                        await saveData('cards_v2', { list: data.cards });
                                                        if(data.banks) await saveData('banks_v1', { list: data.banks });
                                                        showToast("ÈÇÑÂéüÊàêÂäü");
                                                    }
                                                } catch(err) { showToast("Ê†ºÂºèÈåØË™§", "error"); }
                                            };
                                            reader.readAsText(file);
                                        }} />
                                        <button onClick={() => fileInputRef.current.click()} className="bg-gray-100 px-4 py-2 rounded-lg text-sm font-bold flex gap-1 active:bg-gray-200"><Upload className="w-4 h-4"/> ÈÇÑÂéü</button>
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="w-full bg-red-50 text-red-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2 active:bg-red-100"><LogOut className="w-5 h-5"/> ÁôªÂá∫</button>
                            </div>
                        </div>
                    );
                }

                // 4. LOGIN (Fallback)
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                            <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Key className="w-10 h-10 text-blue-600" /></div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-8">‰ø°Áî®Âç°ÁÆ°ÂÆ∂</h1>
                            <form onSubmit={handleLogin} className="space-y-6">
                                <input type="text" value={inputSyncId} onChange={(e) => setInputSyncId(e.target.value)} placeholder="Ë®≠ÂÆö‰∏ÄÁµÑÈÄ£ÂãïÂØÜÁ¢º" className="w-full px-4 py-4 rounded-2xl border border-gray-200 outline-none text-center text-xl bg-gray-50 focus:border-blue-500 transition shadow-sm" />
                                <button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition active:scale-95 text-lg shadow-lg shadow-blue-200">ÈÄ≤ÂÖ•</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const renderModal = () => {
                if(!modal.type) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-end justify-center">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm modal-overlay" onClick={() => setModal({ type: null })}></div>
                        <div className="bg-white w-full max-w-md rounded-t-3xl shadow-2xl modal-content z-10 relative overflow-hidden flex flex-col max-h-[92vh]">
                            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                                <div className="w-8"></div> {/* Spacer */}
                                <div className="w-12 h-1.5 bg-gray-200 rounded-full"></div>
                                <button onClick={() => setModal({ type: null })} className="p-2 bg-gray-100 rounded-full active:bg-gray-200"><X className="w-5 h-5 text-gray-600"/></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto pb-safe">
                                {/* SPEND MODAL */}
                                {modal.type === 'spend' && (
                                    <>
                                        <div className="text-center mb-6">
                                            <div className={`w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3 ${modal.data.color} text-white shadow-lg`}>
                                                <DollarSign className="w-8 h-8"/>
                                            </div>
                                            <h3 className="text-2xl font-bold text-gray-800">{modal.data.name}</h3>
                                            <div className="text-gray-400 mt-1">ÁõÆÂâçÁ¥ØÁ©ç: ${modal.data.currentSpend?.toLocaleString()}</div>
                                            {(modal.data.tags && modal.data.tags.length > 0) && (
                                                <div className="flex gap-1 justify-center mt-3">
                                                    {modal.data.tags.map((t, i) => <span key={i} className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">{t}</span>)}
                                                </div>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-3 mb-6 bg-gray-100 p-1.5 rounded-2xl">
                                            <button onClick={() => setIsSubtractMode(false)} className={`flex-1 py-3 rounded-xl text-sm font-bold transition ${!isSubtractMode ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}>Êñ∞Â¢ûÊ∂àË≤ª</button>
                                            <button onClick={() => setIsSubtractMode(true)} className={`flex-1 py-3 rounded-xl text-sm font-bold transition ${isSubtractMode ? 'bg-white shadow text-red-600' : 'text-gray-400'}`}>ÈÄÄÊ¨æ/Êâ£Èô§</button>
                                        </div>
                                        
                                        <div className="relative mb-8">
                                            <span className="absolute left-6 top-1/2 -translate-y-1/2 text-3xl font-bold text-gray-400">$</span>
                                            <input type="number" inputMode="decimal" autoFocus value={spendAmount} onChange={e => setSpendAmount(e.target.value)} className="w-full bg-gray-50 border-2 border-transparent focus:border-blue-500 rounded-3xl py-6 pl-12 pr-6 text-4xl font-bold outline-none text-center shadow-inner" placeholder="0" />
                                        </div>
                                        
                                        <button onClick={addSpend} className={`w-full py-4 rounded-2xl text-white font-bold text-xl shadow-xl shadow-blue-200 btn-press mb-4 ${isSubtractMode ? 'bg-red-500 shadow-red-200' : 'bg-blue-600'}`}>
                                            {isSubtractMode ? 'Á¢∫Ë™çÊâ£Èô§' : 'Á¢∫Ë™çË®òÂ∏≥'}
                                        </button>
                                    </>
                                )}

                                {/* SETTLE MODAL */}
                                {modal.type === 'settle' && (
                                    <>
                                         <div className="text-center mb-8">
                                            <div className="w-16 h-16 bg-purple-100 rounded-full mx-auto flex items-center justify-center mb-4 text-purple-600 shadow-sm">
                                                <FileCheck className="w-8 h-8"/>
                                            </div>
                                            <h3 className="text-2xl font-bold text-gray-800">Á¢∫Ë™çÁµêÁÆó?</h3>
                                            <p className="text-gray-500 mt-2">
                                                {modal.data ? `Â∞áÁµêÁÆó„Äå${modal.data.name}„ÄçÁõÆÂâçÁöÑÊ∂àË≤ªÈáëÈ°ç` : (modal.settleType === 'month' ? `Â∞áÁµêÁÆóÊâÄÊúâ„ÄåÊúàÂà∂„ÄçÂç°ÁâáÁöÑÊ∂àË≤ªÈáëÈ°ç` : `Âü∑Ë°åÈÄ±ÊúüÁµêÁÆóÊ™¢Êü•`)}
                                            </p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-3xl mb-8 text-base text-gray-600">
                                            <ul className="list-disc pl-5 space-y-2">
                                                <li>ÈáëÈ°çÂ∞áÊ≠∏Èõ∂‰∏¶Ë®àÂÖ•Ê≠∑Âè≤Á¥ÄÈåÑ</li>
                                                <li>Âª∫Ë≠∞Á¢∫Ë™çÈäÄË°åÂ∑≤Âá∫Â∏≥ÂæåÂÜçÂü∑Ë°å</li>
                                                {modal.data ? 
                                                    <li className="font-bold text-gray-800 pt-1">ÁµêÁÆóÈáëÈ°ç: ${modal.data.currentSpend.toLocaleString()}</li> : 
                                                    (modal.settleType === 'month' ?
                                                    <li className="font-bold text-gray-800 pt-1">È†êË®àÁµêÁÆó: {cards.filter(c => c.currentSpend > 0 && (c.cycleType === 'month' || !c.cycleType)).length} ÂºµÂç°Áâá</li> :
                                                    <li>Ê™¢Êü•ÊâÄÊúâ„ÄåÂ∏≥ÂñÆÊó•„ÄçÂ∑≤ÈÅéÁöÑÂç°Áâá</li>)
                                                }
                                            </ul>
                                        </div>
                                        <button onClick={settleCards} className="w-full bg-purple-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-purple-200 btn-press text-lg mb-4">Á¢∫Ë™çÁµêÁÆó</button>
                                    </>
                                )}

                                {/* EDIT CARD MODAL */}
                                {modal.type === 'editCard' && (
                                    <div className="space-y-6">
                                        <h3 className="text-2xl font-bold text-center mb-2">{modal.data ? 'Á∑®ËºØÂç°Áâá' : 'Êñ∞Â¢ûÂç°Áâá'}</h3>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">Âç°ÁâáÂêçÁ®±</label>
                                                <input value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 focus:border-blue-500 font-bold" placeholder="‰æãÂ¶Ç: ÂØåÈÇ¶JÂç°"/>
                                            </div>

                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">Ê®ôÁ±§ (Tag)</label>
                                                <div className="relative">
                                                    <Tag className="absolute left-4 top-4 w-5 h-5 text-gray-400"/>
                                                    <input value={tagInput} onChange={e=>setTagInput(e.target.value)} className="w-full bg-gray-50 p-4 pl-12 rounded-2xl outline-none border border-gray-100 focus:border-blue-500" placeholder="‰æãÂ¶Ç: Á∂≤Ë≥º, ÊóÖÈÅä"/>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">ÁôºÂç°ÈäÄË°å</label>
                                                <div className="relative">
                                                    <select value={formData.bankId||''} onChange={e=>setFormData({...formData, bankId:e.target.value})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 appearance-none font-bold">
                                                        <option value="">ÁÑ° / ÊâãÂãïË®≠ÂÆö</option>
                                                        {banks.map(b => <option key={b.id} value={b.id}>{b.name} ({b.billingDay}Êó•Áµê)</option>)}
                                                    </select>
                                                    <ChevronDown className="absolute right-4 top-4 text-gray-400 w-5 h-5 pointer-events-none"/>
                                                </div>
                                            </div>

                                            {!formData.bankId && (
                                                <div className="flex gap-4">
                                                    <div className="flex-1">
                                                        <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">ÁµêÂ∏≥Êó•</label>
                                                        <input type="number" value={formData.billingDay||''} onChange={e=>setFormData({...formData, billingDay:parseInt(e.target.value)})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 text-center font-bold" placeholder="Êó•"/>
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">Áπ≥Ê¨æÊó•</label>
                                                        <input type="number" value={formData.paymentDay||''} onChange={e=>setFormData({...formData, paymentDay:parseInt(e.target.value)})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 text-center font-bold" placeholder="Êó•"/>
                                                    </div>
                                                </div>
                                            )}

                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">ÈÄ±ÊúüË®≠ÂÆö</label>
                                                <div className="flex bg-gray-100 p-1.5 rounded-2xl">
                                                    <button onClick={()=>setFormData({...formData, cycleType:'month'})} className={`flex-1 py-3 rounded-xl text-sm font-bold transition ${formData.cycleType!=='billing'?'bg-white shadow text-blue-600':'text-gray-400'}`}>ÊåâÊúàÈáçÁΩÆ</button>
                                                    <button onClick={()=>setFormData({...formData, cycleType:'billing'})} className={`flex-1 py-3 rounded-xl text-sm font-bold transition ${formData.cycleType==='billing'?'bg-white shadow text-blue-600':'text-gray-400'}`}>ÊåâÂ∏≥ÂñÆÊó•</button>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-2 block">ÂõûÈ•ãË®≠ÂÆö</label>
                                                {(formData.rewards||[]).map((r, i) => (
                                                    <div key={i} className="flex gap-2 mb-3">
                                                        <input value={r.name} onChange={e=>{const n=[...formData.rewards]; n[i].name=e.target.value; setFormData({...formData, rewards:n})}} className="flex-[2] bg-gray-50 p-3 rounded-xl border border-gray-100" placeholder="È†ÖÁõÆ"/>
                                                        <div className="relative w-20">
                                                            <input type="number" value={r.rate} onChange={e=>{const n=[...formData.rewards]; n[i].rate=e.target.value; setFormData({...formData, rewards:n})}} className="w-full bg-gray-50 p-3 rounded-xl text-center border border-gray-100" placeholder="%"/>
                                                            <span className="absolute right-2 top-3 text-gray-400 text-xs">%</span>
                                                        </div>
                                                        <input type="number" value={r.cap} onChange={e=>{const n=[...formData.rewards]; n[i].cap=e.target.value; setFormData({...formData, rewards:n})}} className="w-24 bg-gray-50 p-3 rounded-xl text-center border border-gray-100" placeholder="‰∏äÈôê"/>
                                                        <button onClick={()=>{const n=[...formData.rewards]; n.splice(i,1); setFormData({...formData, rewards:n})}} className="text-red-400 p-2"><X className="w-5 h-5"/></button>
                                                    </div>
                                                ))}
                                                <button onClick={()=>setFormData({...formData, rewards:[...(formData.rewards||[]), {name:'',rate:'',cap:''}]})} className="w-full py-3 border border-dashed border-blue-300 rounded-xl text-blue-500 font-bold flex items-center justify-center gap-1"><Plus className="w-4 h-4"/> Êñ∞Â¢ûÂõûÈ•ãË¶èÂâá</button>
                                            </div>

                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-2 block">Âç°ÁâáÈ°èËâ≤</label>
                                                <div className="flex gap-3 overflow-x-auto pb-4 scroll-touch px-1">
                                                    {COLORS.map(c => (
                                                        <button key={c.value} onClick={()=>setFormData({...formData, color:c.value})} className={`w-12 h-12 rounded-full flex-shrink-0 ${c.value} shadow-sm transition-transform ${formData.color===c.value?'ring-4 ring-offset-2 ring-gray-300 scale-110':''}`}></button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-3 pt-2 pb-6">
                                            {modal.data && <button onClick={()=>deleteCard(modal.data.id)} className="p-4 rounded-2xl bg-red-50 text-red-500 active:bg-red-100"><Trash2 className="w-6 h-6"/></button>}
                                            <button onClick={saveCard} className="flex-1 bg-blue-600 text-white font-bold rounded-2xl py-4 shadow-lg shadow-blue-200 btn-press text-lg">ÂÑ≤Â≠òË®≠ÂÆö</button>
                                        </div>
                                    </div>
                                )}

                                 {/* EDIT BANK MODAL */}
                                {modal.type === 'editBank' && (
                                    <div className="space-y-6">
                                        <h3 className="text-2xl font-bold text-center mb-4">{modal.data ? 'Á∑®ËºØÈäÄË°å' : 'Êñ∞Â¢ûÈäÄË°å'}</h3>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">ÈäÄË°åÂêçÁ®±</label>
                                                <input value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 focus:border-blue-500 font-bold text-lg" placeholder="‰æãÂ¶Ç: ‰∏≠Âúã‰ø°Ë®ó"/>
                                            </div>

                                            <div className="flex gap-4">
                                                <div className="flex-1">
                                                    <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">ÁµêÂ∏≥Êó•</label>
                                                    <div className="relative">
                                                        <input type="number" value={formData.billingDay||''} onChange={e=>setFormData({...formData, billingDay:parseInt(e.target.value)})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 text-center font-bold text-lg" placeholder="Êó•"/>
                                                        <span className="absolute right-4 top-4 text-gray-400">Ëôü</span>
                                                    </div>
                                                </div>
                                                <div className="flex-1">
                                                    <label className="text-sm font-bold text-gray-500 ml-1 mb-1 block">Áπ≥Ê¨æÊó•</label>
                                                    <div className="relative">
                                                        <input type="number" value={formData.paymentDay||''} onChange={e=>setFormData({...formData, paymentDay:parseInt(e.target.value)})} className="w-full bg-gray-50 p-4 rounded-2xl outline-none border border-gray-100 text-center font-bold text-lg" placeholder="Êó•"/>
                                                        <span className="absolute right-4 top-4 text-gray-400">Ëôü</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-3 pt-4 pb-6">
                                            {modal.data && <button onClick={()=>deleteBank(modal.data.id)} className="p-4 rounded-2xl bg-red-50 text-red-500 active:bg-red-100"><Trash2 className="w-6 h-6"/></button>}
                                            <button onClick={saveBank} className="flex-1 bg-blue-600 text-white font-bold rounded-2xl py-4 shadow-lg shadow-blue-200 btn-press text-lg">ÂÑ≤Â≠òË®≠ÂÆö</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <Layout view={view} setView={setView} toast={toast}>
                    {content()}
                    {renderModal()}
                </Layout>
            );
        }

        // Layout Component
        const Layout = ({ children, view, setView, toast }) => (
            <>
                {children}
                {view !== 'login' && setView && (
                    <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center pb-safe pt-2 z-40 shadow-[0_-4px_20px_-4px_rgba(0,0,0,0.05)] h-[84px] box-content">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center justify-center w-full h-full active:scale-95 transition ${view === 'dashboard' ? 'nav-active' : 'text-gray-400'}`}>
                            <CreditCard className={`w-7 h-7 mb-1 ${view === 'dashboard' ? 'fill-blue-100' : ''}`}/>
                            <span className="text-[11px] font-bold">Âç°Áâá</span>
                        </button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center justify-center w-full h-full active:scale-95 transition ${view === 'history' ? 'nav-active' : 'text-gray-400'}`}>
                            <History className={`w-7 h-7 mb-1 ${view === 'history' ? 'fill-blue-100' : ''}`}/>
                            <span className="text-[11px] font-bold">Á¥ÄÈåÑ</span>
                        </button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center justify-center w-full h-full active:scale-95 transition ${view === 'settings' ? 'nav-active' : 'text-gray-400'}`}>
                            <Settings className={`w-7 h-7 mb-1 ${view === 'settings' ? 'fill-blue-100' : ''}`}/>
                            <span className="text-[11px] font-bold">Ë®≠ÂÆö</span>
                        </button>
                    </div>
                )}
                {toast && <Toast message={toast.msg} type={toast.type} />}
            </>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

