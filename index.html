<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>信用卡管家 (優化終極版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* Toast 動畫 */
        @keyframes slide-up {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-20">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Minus, Trash2, Edit2, RotateCcw, CreditCard, DollarSign, TrendingUp, AlertCircle, X, Tag, Cloud, RefreshCw, Calculator, ChevronDown, ChevronUp, Layers, History, Calendar, ArrowLeft, Key, LogIn, LogOut, CheckCircle, Save, AlertTriangle, Bell } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, deleteDoc, updateDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from 'firebase/firestore';

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDraphMDkK-uXpC-PMRM75p9h_e6VYSXEQ",
            authDomain: "cards-reward.firebaseapp.com",
            projectId: "cards-reward",
            storageBucket: "cards-reward.firebasestorage.app",
            messagingSenderId: "450336524248",
            appId: "1:450336524248:web:ecf5b879698b590e6414ad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 預設卡片資料
        const DEFAULT_CARDS = [
            {
                id: 1,
                name: "永豐 Sport (Google Pay)",
                rewards: [
                    { name: "基本回饋", rate: 1, cap: 0 },
                    { name: "運動獎勵", rate: 1, cap: 5000 },
                    { name: "指定支付", rate: 5, cap: 6000 }
                ],
                currentSpend: 0,
                color: "bg-red-500",
                tags: ["加油", "高鐵", "Apple Pay"]
            }
        ];

        const COLORS = [
            { name: "紅色", value: "bg-red-500" },
            { name: "藍色", value: "bg-blue-500" },
            { name: "綠色", value: "bg-green-500" },
            { name: "紫色", value: "bg-purple-500" },
            { name: "橘色", value: "bg-orange-500" },
            { name: "黑色", value: "bg-gray-800" },
            { name: "青色", value: "bg-teal-600" },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [syncId, setSyncId] = useState(() => localStorage.getItem('card_manager_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState(''); 

            const [cards, setCards] = useState([]);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [view, setView] = useState('dashboard');

            // UI States
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [isSpendModalOpen, setIsSpendModalOpen] = useState(false);
            const [isSettleModalOpen, setIsSettleModalOpen] = useState(false);
            const [isHistoryEditModalOpen, setIsHistoryEditModalOpen] = useState(false);
            const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);
            
            // Toast State
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

            const [currentEditingCard, setCurrentEditingCard] = useState(null);
            const [editingHistoryId, setEditingHistoryId] = useState(null);
            const [editingHistoryMonth, setEditingHistoryMonth] = useState("");
            const [editingHistoryCards, setEditingHistoryCards] = useState([]);
            const [deleteTargetId, setDeleteTargetId] = useState(null);

            const [expandedCardId, setExpandedCardId] = useState(null);
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            const [formName, setFormName] = useState("");
            const [formColor, setFormColor] = useState(COLORS[1].value);
            const [formTags, setFormTags] = useState([]); 
            const [tagInput, setTagInput] = useState(""); 
            const [formRewards, setFormRewards] = useState([]);
            const [formCurrentSpend, setFormCurrentSpend] = useState("");

            const [historyFormSpend, setHistoryFormSpend] = useState("");
            const [historyFormReward, setHistoryFormReward] = useState("");

            const [selectedTag, setSelectedTag] = useState("全部");
            const [spendAmount, setSpendAmount] = useState("");
            const [isSubtractMode, setIsSubtractMode] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !syncId) { setLoading(false); return; }
                setLoading(true);
                const docRef = doc(db, 'users', syncId, 'data', 'cards_v2');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) { setCards(docSnap.data().list || []); } 
                    else { setDoc(docRef, { list: DEFAULT_CARDS }); setCards(DEFAULT_CARDS); }
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [user, syncId]);

            useEffect(() => {
                if (!user || !syncId || view !== 'history') return;
                const historyRef = collection(db, 'users', syncId, 'history');
                const q = query(historyRef, orderBy('monthStr', 'desc'));
                return onSnapshot(q, (snapshot) => {
                    setHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, [user, syncId, view]);

            // Toast Helper
            const showToast = (msg, type = 'success') => {
                setToast({ show: true, message: msg, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            const handleLogin = (e) => { e.preventDefault(); if (!tempSyncId.trim()) return showToast("請輸入連動密碼", 'error'); setSyncId(tempSyncId.trim()); localStorage.setItem('card_manager_sync_id', tempSyncId.trim()); };
            const handleLogout = () => { if(confirm("確定要登出嗎？")) { setSyncId(''); localStorage.removeItem('card_manager_sync_id'); setCards([]); }};

            const updateCardsData = async (newCards) => { try { await setDoc(doc(db, 'users', syncId, 'data', 'cards_v2'), { list: newCards }, { merge: true }); } catch (e) { throw e; }};
            const saveCardsToCloud = async (newCards) => { setCards(newCards); if (!user || !syncId) return; setIsSyncing(true); try { await updateCardsData(newCards); } catch (e) { showToast("儲存失敗: " + e.message, 'error'); } finally { setIsSyncing(false); }};

            const calculateReward = (card) => {
                let totalReward = 0; const spend = parseFloat(card.currentSpend) || 0; const breakdown = [];
                let rewards = card.rewards || []; if (rewards.length === 0) rewards = [{ name: '回饋', rate: card.highRate || 0, cap: card.limit || 0 }];
                rewards.forEach(r => {
                    const rate = parseFloat(r.rate); const cap = parseFloat(r.cap); let validSpend = spend; let isCapped = false;
                    if (cap > 0 && spend > cap) { validSpend = cap; isCapped = true; }
                    const amount = Math.floor(validSpend * (rate / 100)); totalReward += amount;
                    breakdown.push({ name: r.name, rate, cap, validSpend, amount, isCapped });
                });
                return { total: totalReward, breakdown };
            };

            const getCaps = (card) => (card.rewards || []).map(r => parseFloat(r.cap)).filter(c => c > 0).sort((a, b) => a - b);
            const getMaxCap = (card) => { const caps = getCaps(card); return caps.length > 0 ? caps[caps.length - 1] : 0; };
            const getTotalRate = (card) => (card.rewards || []).reduce((acc, cur) => acc + parseFloat(cur.rate || 0), 0);
            const allTags = ["全部", ...Array.from(new Set(cards.flatMap(c => c.tags || [])))];
            const filteredCards = selectedTag === "全部" ? cards : cards.filter(c => c.tags && c.tags.includes(selectedTag));
            const totalSpend = cards.reduce((acc, card) => acc + (parseFloat(card.currentSpend) || 0), 0);
            const totalReward = cards.reduce((acc, card) => acc + calculateReward(card).total, 0);
            const totalRate = totalSpend > 0 ? ((totalReward / totalSpend) * 100).toFixed(2) : 0;

            const handleResetMonth = async () => {
                const currentMonthStr = new Date().toISOString().slice(0, 7);
                setIsSyncing(true);
                try {
                    const historyEntry = {
                        monthStr: currentMonthStr, totalSpend, totalReward, timestamp: new Date().toISOString(),
                        cardsSnapshot: cards.filter(c => c.currentSpend > 0).map(c => ({ name: c.name, color: c.color, spend: c.currentSpend, reward: calculateReward(c).total }))
                    };
                    await setDoc(doc(collection(db, 'users', syncId, 'history'), currentMonthStr), historyEntry);
                    const resetCards = cards.map(c => ({ ...c, currentSpend: 0 }));
                    setCards(resetCards); await updateCardsData(resetCards);
                    setIsSettleModalOpen(false); showToast("結算成功！已存入歷史");
                } catch (e) { console.error(e); showToast(`結算失敗：${e.message}`, 'error'); } finally { setIsSyncing(false); }
            };

            // History Functions
            const openHistoryEditModal = (item) => {
                setEditingHistoryId(item.id); setEditingHistoryMonth(item.monthStr);
                setEditingHistoryCards(JSON.parse(JSON.stringify(item.cardsSnapshot || [])));
                setIsHistoryEditModalOpen(true);
            };
            const confirmDeleteHistory = (id) => { setDeleteTargetId(id); setIsDeleteConfirmOpen(true); };
            const executeDeleteHistory = async () => {
                if (!deleteTargetId) return; setIsSyncing(true);
                try { await deleteDoc(doc(db, 'users', syncId, 'history', deleteTargetId)); setIsDeleteConfirmOpen(false); setDeleteTargetId(null); showToast("紀錄已刪除"); } catch (e) { showToast("刪除失敗", 'error'); } finally { setIsSyncing(false); }
            };
            const handleUpdateHistory = async () => {
                if (!editingHistoryId) return; setIsSyncing(true);
                const newTotalSpend = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.spend) || 0), 0);
                const newTotalReward = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.reward) || 0), 0);
                try { await updateDoc(doc(db, 'users', syncId, 'history', editingHistoryId), { totalSpend: newTotalSpend, totalReward: newTotalReward, cardsSnapshot: editingHistoryCards }); setIsHistoryEditModalOpen(false); showToast("修正完成"); } catch (e) { showToast("更新失敗", 'error'); } finally { setIsSyncing(false); }
            };
            const handleHistoryCardChange = (i, f, v) => { const n = [...editingHistoryCards]; n[i][f] = parseFloat(v) || 0; setEditingHistoryCards(n); };
            const handleHistoryCardDelete = (idx) => { if(confirm("刪除這筆卡片紀錄？")) setEditingHistoryCards(editingHistoryCards.filter((_, i) => i !== idx)); };
            const editingTotalSpend = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.spend) || 0), 0);
            const editingTotalReward = editingHistoryCards.reduce((acc, c) => acc + (parseFloat(c.reward) || 0), 0);

            // Helpers
            const getYearlySummary = () => { const s = {}; history.forEach(i => { const y = i.monthStr.slice(0, 4); if (!s[y]) s[y] = { spend: 0, reward: 0 }; s[y].spend += i.totalSpend; s[y].reward += i.totalReward; }); return Object.entries(s).sort((a, b) => b[0] - a[0]); };
            const handleSaveCard = () => { if (!formName) return showToast("請輸入名稱", 'error'); const cleanRewards = formRewards.filter(r => r.name && r.rate).map(r => ({ name: r.name, rate: parseFloat(r.rate), cap: parseFloat(r.cap) || 0 })); const newCardData = { id: currentEditingCard ? currentEditingCard.id : Date.now(), name: formName, rewards: cleanRewards, color: formColor, tags: formTags, currentSpend: parseFloat(formCurrentSpend) || 0 }; saveCardsToCloud(currentEditingCard ? cards.map(c => c.id === currentEditingCard.id ? newCardData : c) : [...cards, newCardData]); closeEditModal(); showToast("卡片已儲存"); };
            const handleDeleteCard = (id) => { if(confirm("確定要刪除這張卡片嗎？")) { saveCardsToCloud(cards.filter(c => c.id !== id)); closeEditModal(); showToast("卡片已刪除"); }};
            const handleAddSpend = () => { const amt = parseFloat(spendAmount); if (isNaN(amt) || !currentEditingCard) return; const finalAmt = isSubtractMode ? -amt : amt; saveCardsToCloud(cards.map(c => c.id === currentEditingCard.id ? { ...c, currentSpend: Math.max(0, c.currentSpend + finalAmt) } : c)); closeSpendModal(); showToast(isSubtractMode ? "金額已扣除" : "記帳成功"); };
            const handleAddTag = () => { if (tagInput && !formTags.includes(tagInput)) { setFormTags([...formTags, tagInput]); setTagInput(""); }};
            const handleRewardChange = (i, f, v) => { const n = [...formRewards]; n[i][f] = v; setFormRewards(n); };
            const removeRewardRow = (i) => { const n = [...formRewards]; n.splice(i, 1); setFormRewards(n); };
            const openEditModal = (card = null) => { setCurrentEditingCard(card); setFormName(card?.name||""); setFormColor(card?.color||COLORS[1].value); setFormTags(card?.tags||[]); setFormRewards(card?.rewards || [{ name: '基本回饋', rate: '1', cap: '0' }, { name: '指定加碼', rate: '', cap: '' }]); setFormCurrentSpend(card?.currentSpend || 0); setIsEditModalOpen(true); };
            const openSpendModal = (card) => { setCurrentEditingCard(card); setSpendAmount(""); setIsSubtractMode(false); setIsSpendModalOpen(true); };
            const closeEditModal = () => setIsEditModalOpen(false);
            const closeSpendModal = () => setIsSpendModalOpen(false);
            const toggleExpand = (cardId) => setExpandedCardId(expandedCardId === cardId ? null : cardId);

            if (!syncId) return <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6"><div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center"><div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Key className="w-8 h-8 text-blue-600" /></div><h1 className="text-2xl font-bold text-gray-800 mb-2">輸入連動密碼</h1><p className="text-gray-500 text-sm mb-6">請在不同裝置輸入相同的密碼，即可同步您的記帳資料。</p><form onSubmit={handleLogin} className="space-y-4"><input type="text" value={tempSyncId} onChange={(e) => setTempSyncId(e.target.value)} placeholder="例如：my-secret-123" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none text-center text-lg bg-gray-50" /><button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition active:scale-95 flex items-center justify-center gap-2"><LogIn className="w-5 h-5" /> 開始使用</button></form></div></div>;
            if (loading) return <div className="min-h-screen flex items-center justify-center text-gray-400">讀取資料中...</div>;

            // --- History View ---
            if (view === 'history') {
                const yearlySummary = getYearlySummary();
                return (
                    <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
                        <div className="bg-white px-6 pt-8 pb-4 rounded-b-3xl shadow-sm sticky top-0 z-20 flex justify-between items-center"><h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><History className="w-6 h-6 text-purple-600" />歷史帳本</h1><button onClick={() => setView('dashboard')} className="text-sm flex items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-full text-gray-600 active:scale-95 transition"><ArrowLeft className="w-4 h-4" /> 返回</button></div>
                        <div className="px-4 py-4 space-y-4">
                            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg"><h2 className="font-bold text-lg mb-3 flex items-center gap-2"><Calendar className="w-5 h-5"/> 年度總結</h2>{yearlySummary.length===0?<p className="opacity-70">尚無紀錄</p> : yearlySummary.map(([y, d]) => (<div key={y} className="flex justify-between border-b border-white/20 pb-2 mb-2 last:border-0"><span className="font-bold">{y}</span><div className="text-right"><div>${d.spend.toLocaleString()}</div><div className="text-xs bg-white/20 px-2 rounded-full">回饋 ${d.reward.toLocaleString()}</div></div></div>))}</div>
                            {history.map(h => (
                                <div key={h.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                                    <div onClick={() => setExpandedHistoryId(expandedHistoryId === h.id ? null : h.id)} className="flex justify-between items-center cursor-pointer">
                                        <div className="font-bold text-lg text-gray-800">{h.monthStr} <span className="text-sm font-normal text-gray-500 ml-2">${h.totalSpend.toLocaleString()}</span></div>
                                        <ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${expandedHistoryId === h.id ? 'rotate-180' : ''}`} />
                                    </div>
                                    {expandedHistoryId === h.id && (
                                        <div className="mt-3 pt-3 border-t border-gray-100 space-y-2">
                                            {h.cardsSnapshot?.map((c, i) => (
                                                <div key={i} className="flex justify-between text-sm"><div className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${c.color}`}></span><span>{c.name}</span></div><div className="text-right"><div>${c.spend.toLocaleString()}</div><div className="text-xs text-green-600">+${c.reward}</div></div></div>
                                            ))}
                                            <div className="flex gap-3 pt-2 mt-4 border-t border-gray-100">
                                                <button onClick={(e) => { e.stopPropagation(); openHistoryEditModal(h); }} className="flex-1 py-2 text-sm text-blue-600 bg-blue-50 rounded-lg flex items-center justify-center gap-1 hover:bg-blue-100 transition"><Edit2 className="w-3 h-3" /> 修改細項</button>
                                                <button onClick={(e) => { e.stopPropagation(); confirmDeleteHistory(h.id); }} className="flex-1 py-2 text-sm text-red-600 bg-red-50 rounded-lg flex items-center justify-center gap-1 hover:bg-red-100 transition"><Trash2 className="w-3 h-3" /> 刪除紀錄</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        {/* History Detail Modal & Delete Confirm Modal - Same logic as before but with Toast */}
                        {isHistoryEditModalOpen && (
                            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
                                <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-fade-in-up my-auto">
                                    <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-3"><h3 className="font-bold text-lg text-gray-800">修改明細 ({editingHistoryMonth})</h3><button onClick={() => setIsHistoryEditModalOpen(false)}><X className="w-6 h-6 text-gray-400" /></button></div>
                                    <div className="bg-gray-50 rounded-xl p-3 mb-4 flex justify-between items-center"><div className="text-center flex-1 border-r border-gray-200"><div className="text-xs text-gray-500">總消費 (自動)</div><div className="font-bold text-lg">${editingTotalSpend.toLocaleString()}</div></div><div className="text-center flex-1"><div className="text-xs text-gray-500">總回饋 (自動)</div><div className="font-bold text-lg text-green-600">+${editingTotalReward.toLocaleString()}</div></div></div>
                                    <div className="space-y-3 max-h-64 overflow-y-auto pr-1">
                                        {editingHistoryCards.map((card, index) => (
                                            <div key={index} className="bg-white border border-gray-200 rounded-xl p-3">
                                                <div className="flex items-center gap-2 mb-2 font-medium text-sm text-gray-700"><span className={`w-2 h-2 rounded-full ${card.color}`}></span>{card.name}<button onClick={() => handleHistoryCardDelete(index)} className="ml-auto text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></div>
                                                <div className="flex gap-2"><div className="flex-1"><label className="text-[10px] text-gray-400 block mb-0.5">消費</label><input type="number" value={card.spend} onChange={(e) => handleHistoryCardChange(index, 'spend', e.target.value)} className="w-full px-2 py-1.5 text-sm border border-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-500" inputMode="decimal" /></div><div className="flex-1"><label className="text-[10px] text-gray-400 block mb-0.5">回饋金</label><input type="number" value={card.reward} onChange={(e) => handleHistoryCardChange(index, 'reward', e.target.value)} className="w-full px-2 py-1.5 text-sm border border-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-green-500 text-green-600 font-bold" inputMode="decimal" /></div></div>
                                            </div>
                                        ))}
                                        {editingHistoryCards.length === 0 && <p className="text-center text-gray-400 text-sm py-4">無卡片紀錄</p>}
                                    </div>
                                    <div className="mt-4 pt-3 border-t border-gray-100"><button onClick={handleUpdateHistory} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 flex items-center justify-center gap-2"><Save className="w-4 h-4" /> 儲存修改</button></div>
                                </div>
                            </div>
                        )}
                        {isDeleteConfirmOpen && (
                            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-fade-in-up text-center">
                                    <div className="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><AlertTriangle className="w-8 h-8 text-red-600" /></div>
                                    <h2 className="text-xl font-bold text-gray-800 mb-2">確定刪除嗎？</h2>
                                    <p className="text-gray-500 text-sm mb-6">這筆歷史紀錄將會永久刪除，無法復原。</p>
                                    <div className="flex gap-3"><button onClick={() => setIsDeleteConfirmOpen(false)} className="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">取消</button><button onClick={executeDeleteHistory} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg flex items-center justify-center gap-2">{isSyncing ? <RefreshCw className="w-5 h-5 animate-spin" /> : "確認刪除"}</button></div>
                                </div>
                            </div>
                        )}
                        {toast.show && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-slide-up z-50 whitespace-nowrap"><CheckCircle className="w-5 h-5 text-green-400" /><span>{toast.message}</span></div>}
                    </div>
                );
            }

            // --- Dashboard ---
            return (
                <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
                    <div className="bg-white px-6 pt-8 pb-4 rounded-b-3xl shadow-sm sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <div><h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><CreditCard className="w-6 h-6 text-blue-600" /> 額度管家 {isSyncing && <RefreshCw className="w-3 h-3 animate-spin text-gray-400"/>}</h1><div className="text-xs text-gray-400 mt-1 ml-8 flex items-center gap-1 cursor-pointer" onClick={() => {navigator.clipboard.writeText(syncId); showToast('密碼已複製');}} title="點擊複製"><Key className="w-3 h-3" /> 密碼: <span className="font-mono bg-gray-100 px-1 rounded">{syncId}</span></div></div>
                            <div className="flex gap-2"><button onClick={handleLogout} className="text-gray-400 bg-gray-50 p-2 rounded-full hover:bg-gray-100 transition"><LogOut className="w-5 h-5" /></button><button onClick={() => setView('history')} className="text-gray-500 bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition"><History className="w-5 h-5" /></button><button onClick={() => setIsSettleModalOpen(true)} className="text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600 flex items-center gap-1 hover:bg-red-50 hover:text-red-500 transition"><RotateCcw className="w-3 h-3" /> 結算</button></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3 mb-4"><div className="bg-blue-50 p-3 rounded-2xl border border-blue-100"><div className="text-blue-600 text-xs mb-1 font-medium flex items-center gap-1"><DollarSign className="w-3 h-3"/>本月總刷</div><div className="text-xl font-bold text-blue-900">${totalSpend.toLocaleString()}</div></div><div className="bg-green-50 p-3 rounded-2xl border border-green-100"><div className="text-green-600 text-xs mb-1 font-medium flex items-center gap-1"><TrendingUp className="w-3 h-3"/>預估回饋</div><div className="text-xl font-bold text-green-900">${totalReward.toLocaleString()} <span className="text-xs font-normal">({totalRate}%)</span></div></div></div>
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2">{allTags.map(t => <button key={t} onClick={() => setSelectedTag(t)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition ${selectedTag === t ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-gray-100 text-gray-500'}`}>{t}</button>)}</div>
                    </div>

                    <div className="px-4 py-4 space-y-4">
                        {filteredCards.length === 0 && <div className="text-center py-10 text-gray-400"><div className="bg-white inline-block p-4 rounded-full mb-3 shadow-sm"><CreditCard className="w-8 h-8 text-gray-300"/></div><p>還沒有卡片，點擊下方新增！</p></div>}
                        {filteredCards.map(card => {
                            const caps = getCaps(card); const maxCap = caps.length > 0 ? caps[caps.length - 1] : 0;
                            const spend = card.currentSpend; const percentage = maxCap === 0 ? 0 : Math.min((spend / maxCap) * 100, 100);
                            const isOverLimit = maxCap > 0 && spend >= maxCap; const { total: reward, breakdown } = calculateReward(card);
                            const isExpanded = expandedCardId === card.id;
                            return (
                                <div key={card.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${card.color}`}></div>
                                    <div className="p-5 pb-3">
                                        <div className="flex justify-between items-start mb-2 pl-2">
                                            <div><h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">{card.name} {isOverLimit && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full flex items-center gap-1"><AlertCircle className="w-3 h-3"/> 已滿</span>}</h3><div className="text-sm text-gray-500 mt-0.5">{maxCap > 0 ? (caps.length > 1 ? `分段上限 $${maxCap.toLocaleString()}` : `上限 $${maxCap.toLocaleString()}`) : '無上限'} <span className="text-gray-300 mx-1">|</span> 最高 {getTotalRate(card)}%</div></div>
                                            <button onClick={() => openEditModal(card)} className="text-gray-400 p-2 hover:text-gray-600"><Edit2 className="w-4 h-4" /></button>
                                        </div>
                                        <div className="pl-2 mb-3 flex flex-wrap gap-1.5">{card.tags?.map(t => <span key={t} className="text-xs px-2 py-0.5 bg-gray-50 text-gray-500 rounded-md border border-gray-100">#{t}</span>)}</div>
                                        <div className="pl-2">
                                            <div className="flex justify-between items-end mb-1"><div className="text-2xl font-bold text-gray-900">${spend.toLocaleString()}</div><div className="text-right text-green-600 font-bold text-lg">+${reward}</div></div>
                                            <div className="relative w-full h-2.5 bg-gray-100 rounded-full overflow-hidden mb-2"><div className={`h-full rounded-full transition-all duration-500 ${isOverLimit ? 'bg-red-500' : card.color.replace('bg-', 'bg-')}`} style={{ width: `${percentage}%` }}></div>{caps.map((cap, i) => { if (cap >= maxCap) return null; const tickPos = (cap / maxCap) * 100; return <div key={i} className="absolute top-0 bottom-0 w-0.5 bg-white opacity-70 z-10 shadow-sm" style={{ left: `${tickPos}%` }}></div> })}</div>
                                            {maxCap > 0 && <div className="flex justify-between text-xs text-gray-400"><span>已用 {percentage.toFixed(0)}%</span><span>剩餘: <span className={spend >= maxCap ? 'text-red-500 font-bold' : ''}>${Math.max(0, maxCap - spend).toLocaleString()}</span></span></div>}
                                        </div>
                                    </div>
                                    <div className={`bg-gray-50 border-t border-gray-100 transition-all duration-300 overflow-hidden ${isExpanded ? 'max-h-96' : 'max-h-0'}`}>
                                        <div className="p-4 pl-6 text-sm space-y-2">
                                            <div className="text-xs text-gray-400 font-bold mb-2 uppercase tracking-wide">回饋明細</div>
                                            {breakdown.map((b, i) => (<div key={i} className="flex justify-between items-center"><div className="flex flex-col"><span className="font-medium">{b.name} {b.isCapped && <span className="text-[10px] text-red-500 bg-red-50 px-1 rounded">滿</span>}</span><span className="text-xs text-gray-400">{b.cap>0?`上限 $${b.cap.toLocaleString()}`:'無上限'}</span></div><div className="text-right"><div className="font-mono font-bold">+${b.amount}</div><div className="text-xs text-gray-400">${b.validSpend.toLocaleString()} × {b.rate}%</div></div></div>))}
                                            <div className="border-t border-gray-200 mt-2 pt-2 flex justify-between font-bold text-gray-800"><span>總計</span><span className="text-green-600">+${reward}</span></div>
                                        </div>
                                    </div>
                                    <div className="flex border-t border-gray-100 divide-x divide-gray-100">
                                        <button onClick={() => toggleExpand(card.id)} className="flex-1 py-3 flex items-center justify-center gap-1 text-gray-500 text-sm font-medium hover:bg-gray-50 transition">{isExpanded ? <span>收起 <ChevronUp className="w-4 h-4 inline"/></span> : <span>算式 <ChevronDown className="w-4 h-4 inline"/></span>}</button>
                                        <button onClick={() => openSpendModal(card)} className={`flex-1 py-3 flex items-center justify-center gap-2 text-white font-medium transition active:scale-95 ${card.color}`}><Plus className="w-4 h-4" /> 新增</button>
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={() => openEditModal()} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 flex items-center justify-center gap-2 hover:border-blue-500 hover:text-blue-500 transition"><Plus className="w-5 h-5" /> 新增卡片</button>
                    </div>

                    {/* Modals (Settle / Edit / Spend) omitted for brevity as they are same as before but using Toast */}
                    {/* Re-adding them here to ensure full file integrity */}
                    {isSettleModalOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-fade-in-up text-center"><div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle className="w-8 h-8 text-blue-600" /></div><h2 className="text-2xl font-bold text-gray-800 mb-1">確認結算本月？</h2><p className="text-sm text-gray-500 mb-6">{new Date().toISOString().slice(0, 7)} 的消費紀錄將存入歷史帳本，並將所有卡片額度歸零。</p><div className="bg-gray-50 rounded-xl p-4 mb-6 text-left"><div className="flex justify-between mb-2"><span className="text-gray-500">本月總消費</span><span className="font-bold text-gray-800">${totalSpend.toLocaleString()}</span></div><div className="flex justify-between"><span className="text-gray-500">預估回饋</span><span className="font-bold text-green-600">+${totalReward.toLocaleString()}</span></div></div><div className="flex gap-3"><button onClick={() => setIsSettleModalOpen(false)} className="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">取消</button><button onClick={handleResetMonth} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">{isSyncing ? <RefreshCw className="w-5 h-5 animate-spin" /> : "確認結算"}</button></div></div></div>)}
                    {isEditModalOpen && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto"><div className="bg-white rounded-3xl w-full max-w-sm p-6 space-y-4 my-auto shadow-2xl animate-fade-in-up"><div className="flex justify-between items-center"><h3 className="font-bold text-lg">卡片設定</h3><button onClick={closeEditModal}><X className="w-6 h-6 text-gray-400" /></button></div><input type="text" value={formName} onChange={(e) => setFormName(e.target.value)} placeholder="卡片名稱" className="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500" /><div className="bg-blue-50 p-3 rounded-xl border border-blue-100"><label className="block text-xs font-bold text-blue-700 mb-1">目前已刷金額 (手動修正)</label><div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span><input type="number" value={formCurrentSpend} onChange={(e) => setFormCurrentSpend(e.target.value)} className="w-full pl-7 pr-3 py-2 rounded-lg border border-blue-200 text-blue-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" inputMode="decimal" /></div></div><div><div className="flex justify-between mb-2 text-sm font-medium text-gray-700"><span>回饋規則</span><button onClick={() => setFormRewards([...formRewards, {name:'', rate:'', cap:''}])} className="text-blue-600 text-xs font-bold bg-blue-50 px-2 py-1 rounded">+ 新增</button></div><div className="space-y-2">{formRewards.map((r, i) => (<div key={i} className="flex flex-col gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100"><div className="flex gap-2"><input value={r.name} onChange={(e)=>handleRewardChange(i,'name',e.target.value)} placeholder="名稱" className="flex-1 px-2 py-1 text-sm rounded border border-gray-200 outline-none"/><button onClick={()=>{const n=[...formRewards];n.splice(i,1);removeRewardRow(i)}}><X className="w-4 h-4 text-gray-400"/></button></div><div className="flex gap-2"><div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">%</span><input type="number" value={r.rate} onChange={(e)=>handleRewardChange(i,'rate',e.target.value)} placeholder="%" className="w-full pl-6 pr-2 py-1 text-sm rounded border border-gray-200 outline-none" inputMode="decimal"/></div><div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">限</span><input type="number" value={r.cap} onChange={(e)=>handleRewardChange(i,'cap',e.target.value)} placeholder="0" className="w-full pl-6 pr-2 py-1 text-sm rounded border border-gray-200 outline-none" inputMode="decimal"/></div></div></div>))}</div></div><div><div className="mb-2 text-sm font-medium text-gray-700">顏色</div><div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{COLORS.map(c => <button key={c.value} onClick={() => setFormColor(c.value)} className={`w-6 h-6 rounded-full flex-shrink-0 ${c.value} ${formColor === c.value ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''}`} />)}</div></div><div><div className="mb-2 text-sm font-medium text-gray-700">標籤</div><div className="flex gap-2 mb-2"><input value={tagInput} onChange={(e) => setTagInput(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter')handleAddTag(e)}} placeholder="新增標籤" className="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none"/><button onClick={handleAddTag} className="bg-gray-800 text-white px-3 py-2 rounded-lg text-sm">新增</button></div><div className="flex flex-wrap gap-2">{formTags.map(t => <span key={t} className="px-2 py-1 bg-gray-100 rounded text-xs flex items-center gap-1 border border-gray-200">{t} <button onClick={()=>setFormTags(formTags.filter(tg=>tg!==t))}><X className="w-3 h-3"/></button></span>)}</div></div><div className="flex gap-3 pt-2 border-t border-gray-100">{currentEditingCard && <button onClick={() => handleDeleteCard(currentEditingCard.id)} className="p-3 text-red-500 bg-red-50 rounded-xl hover:bg-red-100"><Trash2 className="w-5 h-5" /></button>}<button onClick={handleSaveCard} className="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition">儲存</button></div></div></div>)}
                    {isSpendModalOpen && (<div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm"><div className="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-fade-in-up"><div className="flex justify-between items-center mb-6"><div><div className="text-sm text-gray-500">新增消費</div><h3 className="font-bold text-xl flex items-center gap-2"><span className={`w-3 h-3 rounded-full ${currentEditingCard?.color}`}></span>{currentEditingCard?.name}</h3></div><button onClick={closeSpendModal} className="bg-gray-100 p-2 rounded-full"><X className="w-5 h-5" /></button></div><div className="flex bg-gray-100 rounded-xl p-1 mb-4"><button onClick={() => setIsSubtractMode(false)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${!isSubtractMode ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'}`}>增加 (+)</button><button onClick={() => setIsSubtractMode(true)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${isSubtractMode ? 'bg-red-500 text-white shadow-sm' : 'text-gray-500'}`}>減少 (-/退款)</button></div><div className="relative mb-6"><span className={`absolute left-4 top-1/2 -translate-y-1/2 text-3xl font-bold ${isSubtractMode ? 'text-red-500' : 'text-gray-400'}`}>{isSubtractMode ? '-' : '$'}</span><input type="number" autoFocus value={spendAmount} onChange={(e) => setSpendAmount(e.target.value)} placeholder="0" className={`w-full pl-10 pr-4 py-4 text-4xl font-bold text-center bg-gray-50 rounded-2xl border-2 border-transparent focus:bg-white outline-none transition ${isSubtractMode ? 'text-red-600 focus:border-red-500' : 'text-gray-900 focus:border-blue-500'}`} inputMode="decimal" /></div><div className="grid grid-cols-4 gap-3 mb-6">{[100, 500, 1000, 5000].map(amt => <button key={amt} onClick={() => setSpendAmount((prev) => String((parseFloat(prev) || 0) + amt))} className="bg-gray-100 text-gray-600 text-sm font-medium py-2 rounded-lg hover:bg-gray-200 transition">+{amt}</button>)}</div><button onClick={handleAddSpend} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg shadow-blue-500/30 transition active:scale-95 ${isSubtractMode ? 'bg-red-500 hover:bg-red-600' : currentEditingCard?.color}`}>{isSubtractMode ? '確認扣除' : '確認記帳'}</button></div></div>)}
                    {/* Toast Notification Component */}
                    {toast.show && (
                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-slide-up z-50 whitespace-nowrap">
                            {toast.type === 'success' ? <CheckCircle className="w-5 h-5 text-green-400" /> : <AlertTriangle className="w-5 h-5 text-yellow-400" />}
                            <span className="font-medium text-sm">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
